<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SAG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="min-h-screen flex flex-col">
        <!-- Navbar -->
        <nav class="bg-blue-600 text-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 flex items-center">
                            <span class="text-xl font-bold">SAG</span>
                        </div>
                        <div class="hidden md:ml-6 md:flex md:items-center md:space-x-4">
                            <a href="dashboard.html" class="px-3 py-2 rounded-md text-sm font-medium bg-blue-700">Dashboard</a>
                            <a href="escolas.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Escolas</a>
                            <a href="turmas.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Turmas</a>
                            <a href="alunos.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Alunos</a>
                            <a href="provas.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Provas</a>
                            <a href="usuarios.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Usuários</a>
                            <a href="gabaritos_geracao.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Gabaritos</a>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span id="userName" class="mr-4"></span>
                        <button id="logoutBtn" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                            <i class="fas fa-sign-out-alt mr-1"></i> Sair
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Mobile menu -->
            <div class="md:hidden hidden" id="mobileMenu">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    <a href="dashboard.html" class="block px-3 py-2 rounded-md text-base font-medium bg-blue-700">Dashboard</a>
                    <a href="escolas.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Escolas</a>
                    <a href="turmas.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Turmas</a>
                    <a href="alunos.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Alunos</a>
                    <a href="provas.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Provas</a>
                    <a href="usuarios.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Usuários</a>
                    <a href="gabaritos_geracao.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Gabaritos</a>
                    <a href="gabaritos_correcao.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Correção</a>
                </div>
            </div>
        </nav>
        
        <!-- Main content -->
        <main class="flex-grow">
            <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                <!-- Dashboard header -->
                <div class="px-4 py-5 sm:px-6 bg-white shadow rounded-lg mb-6">
                    <h1 class="text-2xl font-bold text-gray-900">Dashboard</h1>
                    <p class="mt-1 max-w-2xl text-sm text-gray-500">Visão geral do Sistema de Avaliação e Gerenciamento</p>
                </div>
                
                <!-- Filtros -->
                <div class="bg-white overflow-hidden shadow rounded-lg mb-6 p-4">
                    <div class="flex flex-col space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ANO LETIVO</label>
                                <div class="relative">
                                    <select id="filterYear" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md border">
                                        <option value="all">Todos os anos</option>
                                        <option value="2025">2025</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">REGIÃO</label>
                                <div class="relative">
                                    <select id="filterRegion" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md border">
                                        <option value="all">Todas as regiões</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">GRUPO</label>
                                <div class="relative">
                                    <select id="filterGroup" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md border">
                                        <option value="all">Todos os grupos</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ESCOLA</label>
                                <div class="relative">
                                    <select id="filterSchool" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md border">
                                        <option value="all">Todas as escolas</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ANO ESCOLAR</label>
                                <div class="relative">
                                    <select id="filterGrade" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md border">
                                        <option value="all">Todos os anos</option>
                                        <option value="1">1º Ano</option>
                                        <option value="2">2º Ano</option>
                                        <option value="3">3º Ano</option>
                                        <option value="4">4º Ano</option>
                                        <option value="5">5º Ano</option>
                                        <option value="6">6º Ano</option>
                                        <option value="7">7º Ano</option>
                                        <option value="8">8º Ano</option>
                                        <option value="9">9º Ano</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">TURMA</label>
                                <div class="relative">
                                    <select id="filterClass" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md border">
                                        <option value="all">Todas as turmas</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">RESULTADOS</label>
                                <div class="relative">
                                    <select id="filterResults" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md border">
                                        <option value="all">Todos os resultados</option>
                                        <option value="high">Melhores resultados</option>
                                        <option value="low">Resultados críticos</option>
                                    </select>
                                </div>
                            </div>
                            <div class="md:col-span-2 flex items-end">
                                <button id="applyFilters" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                                    Aplicar Filtros
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Stats overview -->
                <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-5 mb-6">
                    <!-- School stats -->
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 bg-blue-500 rounded-md p-3">
                                    <i class="fas fa-school text-white"></i>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">Escolas</dt>
                                        <dd><div class="text-lg font-medium text-gray-900" id="schoolCount">0</div></dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Class stats -->
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 bg-green-500 rounded-md p-3">
                                    <i class="fas fa-users text-white"></i>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">Turmas</dt>
                                        <dd><div class="text-lg font-medium text-gray-900" id="classCount">0</div></dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Student stats -->
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 bg-purple-500 rounded-md p-3">
                                    <i class="fas fa-user-graduate text-white"></i>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">Alunos</dt>
                                        <dd><div class="text-lg font-medium text-gray-900" id="studentCount">0</div></dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Exam stats -->
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 bg-yellow-500 rounded-md p-3">
                                    <i class="fas fa-file-alt text-white"></i>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">Provas</dt>
                                        <dd><div class="text-lg font-medium text-gray-900" id="examCount">0</div></dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Participation Rate stats -->
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 bg-red-500 rounded-md p-3">
                                    <i class="fas fa-chart-pie text-white"></i>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">Participação</dt>
                                        <dd><div class="text-lg font-medium text-gray-900" id="participationRate">0%</div></dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts -->
                <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 mb-6">
                    <!-- Performance chart -->
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Desempenho por Escolas</h3>
                            <div class="mt-5">
                                <canvas id="schoolPerformanceChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Subject performance chart -->
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Notas Médias por Avaliação</h3>
                            <div class="mt-5">
                                <canvas id="examPerformanceChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Gráficos de Componentes Curriculares e Evolução Bimestral -->
                <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 mb-6">
                    <!-- Componentes Curriculares Chart -->
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Análise de Componentes Curriculares</h3>
                            <div class="mt-5">
                                <canvas id="curriculumComponentsChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Evolução por Bimestre Chart -->
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Evolução por Bimestre</h3>
                            <div class="mt-5">
                                <canvas id="evolutionByTermChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- BNCC Skills List -->
                <div class="bg-white shadow rounded-lg mb-6">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Habilidades BNCC</h3>
                            <div class="mt-3 md:mt-0 flex space-x-2">
                                <button id="btnMostCritical" class="px-3 py-1 bg-red-100 text-red-800 rounded-md text-sm">
                                    Mais Críticas
                                </button>
                                <button id="btnBestResults" class="px-3 py-1 bg-green-100 text-green-800 rounded-md text-sm">
                                    Melhores Resultados
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <div id="bnccSkillsList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                            <!-- Lista de habilidades será carregada dinamicamente -->
                        </div>
                    </div>
                    <!-- Paginação -->
                    <div class="px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                        <div class="flex-1 flex justify-between sm:hidden">
                            <button id="prevPageMobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Anterior
                            </button>
                            <button id="nextPageMobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Próximo
                            </button>
                        </div>
                        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                            <div>
                                <p class="text-sm text-gray-700">
                                    Mostrando <span id="startRange">1</span> a <span id="endRange">10</span> de <span id="totalItems">0</span> resultados
                                </p>
                            </div>
                            <div>
                                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                    <button id="prevPage" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                        <span class="sr-only">Anterior</span>
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <div id="paginationContainer" class="flex">
                                        <!-- Números de páginas serão inseridos dinamicamente -->
                                    </div>
                                    <button id="nextPage" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                        <span class="sr-only">Próximo</span>
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ranking de Alunos -->
                <div class="bg-white shadow rounded-lg mb-6">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Ranking de Alunos</h3>
                            <div class="mt-3 md:mt-0 flex space-x-2">
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Posição
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Aluno
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Escola
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Turma
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Desempenho
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Notas (Maior/Menor)
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="studentRankingList" class="bg-white divide-y divide-gray-200">
                                <!-- Ranking será carregado dinamicamente -->
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                        Carregando ranking de alunos...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Paginação -->
                    <div class="px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                        <div class="flex-1 flex justify-between sm:hidden">
                            <button id="prevRankPageMobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Anterior
                            </button>
                            <button id="nextRankPageMobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Próximo
                            </button>
                        </div>
                        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                            <div>
                                <p class="text-sm text-gray-700">
                                    Mostrando <span id="rankStartRange">1</span> a <span id="rankEndRange">10</span> de <span id="rankTotalItems">0</span> resultados
                                </p>
                            </div>
                            <div>
                                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                    <button id="prevRankPage" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                        <span class="sr-only">Anterior</span>
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <div id="rankPaginationContainer" class="flex">
                                        <!-- Números de páginas serão inseridos dinamicamente -->
                                    </div>
                                    <button id="nextRankPage" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                        <span class="sr-only">Próximo</span>
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="bg-white">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
                <p class="text-center text-sm text-gray-500">SAG - Sistema de Avaliação e Gerenciamento © 2023</p>
            </div>
        </footer>
    </div>
    
    <script src="js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Atualizar nome do usuário
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name;
            }
            
            // Configurar menu mobile
            const mobileMenuBtn = document.querySelector('#mobileMenuBtn');
            const mobileMenu = document.querySelector('#mobileMenu');
            
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', function() {
                    mobileMenu.classList.toggle('hidden');
                });
            }
            
            // Carregar dados da API e atualizar UI
            loadDashboardData();
            
            // Configurar eventos dos filtros
            document.getElementById('applyFilters').addEventListener('click', function() {
                // Remover a chamada de populateFiltersFromAPI que estava resetando os filtros
                applyFilters();
            });

            document.getElementById('btnMostCritical').addEventListener('click', () => {
                // Remover a chamada de populateFiltersFromAPI que estava resetando os filtros
                filterBnccSkills('critical');
            });

            document.getElementById('btnBestResults').addEventListener('click', () => {
                // Remover a chamada de populateFiltersFromAPI que estava resetando os filtros
                filterBnccSkills('best');
            });
            
            // Atualizar o filtro de turmas quando a escola é alterada
            document.getElementById('filterSchool').addEventListener('change', updateClassesFilter);
            
            // Filtros em cascata: região → grupos → escolas
            document.getElementById('filterRegion').addEventListener('change', updateGroupsFilter);
            document.getElementById('filterGroup').addEventListener('change', updateSchoolsFilter);
            
            // Configurar eventos de paginação
            document.getElementById('prevPage')?.addEventListener('click', () => changePage(-1));
            document.getElementById('nextPage')?.addEventListener('click', () => changePage(1));
            document.getElementById('prevPageMobile')?.addEventListener('click', () => changePage(-1));
            document.getElementById('nextPageMobile')?.addEventListener('click', () => changePage(1));
            
            // Adicionar evento para o botão de exportar DOCX
            const btnExportDocx = document.getElementById('btnExportDocx');
            if (btnExportDocx) {
                btnExportDocx.addEventListener('click', exportToDocx);
            }
            
            // Adicionar evento para o botão de exportar Ranking
            const btnExportRanking = document.getElementById('btnExportRanking');
            if (btnExportRanking) {
                btnExportRanking.addEventListener('click', exportRankingToExcel);
            }
            
            // Configurar eventos de paginação do ranking
            document.getElementById('prevRankPage')?.addEventListener('click', () => changeRankPage(-1));
            document.getElementById('nextRankPage')?.addEventListener('click', () => changeRankPage(1));
            document.getElementById('prevRankPageMobile')?.addEventListener('click', () => changeRankPage(-1));
            document.getElementById('nextRankPageMobile')?.addEventListener('click', () => changeRankPage(1));
        });
        
        // Função para carregar todos os dados do dashboard da API
        async function loadDashboardData() {
            try {
                // Mostrar indicadores de carregamento
                document.getElementById('schoolCount').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                document.getElementById('classCount').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                document.getElementById('studentCount').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                document.getElementById('examCount').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                document.getElementById('participationRate').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                // Carregar dados de escolas, turmas, alunos e estatísticas da API
                try {
                    await Promise.all([
                        loadSchoolsFromAPI(),
                        loadClassesFromAPI(),
                        loadStudentsFromAPI(),
                        loadExamsFromAPI()
                    ]);
                    
                    // Depois que todas as chamadas básicas forem concluídas, atualizar a interface
                    updateBasicStatistics();
                    
                    // Popular os seletores de filtro com os dados da API
                    await populateFiltersFromAPI();
                    
                    // Carregar estatísticas após termos os dados básicos
                    try {
                        await loadStatisticsFromAPI();
                    } catch (error) {
                        console.error('Erro ao carregar estatísticas:', error);
                        // Se falhar, garantimos que os contadores básicos continuam atualizados
                        updateBasicStatistics();
                    }
                    
                } catch (error) {
                    console.error('Erro ao carregar dados da API:', error);
                    updateBasicStatistics();
                    
                    // Mesmo com erro, tentar popular filtros com dados locais disponíveis
                    await populateFiltersFromAPI();
                }
                
                // Obter o valor do filtro de ano (se houver)
                const yearFilter = document.getElementById('filterYear').value;
                
                // Renderizar gráficos com o filtro de ano aplicado
                renderDashboardCharts(yearFilter);
                
                // Carregar dados de habilidades e ranking com o filtro de ano aplicado
                loadBnccSkills(yearFilter);
                loadStudentRanking(yearFilter);
                
            } catch (error) {
                console.error('Erro ao carregar dados do dashboard:', error);
                // Garantir que a interface seja atualizada mesmo em caso de erro geral
                updateBasicStatistics();
                
                // Tentar popular filtros mesmo com erro
                await populateFiltersFromAPI();
                
                // Forçar carregamento da interface básica
                renderDashboardCharts();
            }
        }
        
        // Função para atualizar as estatísticas básicas com os dados locais
        function updateBasicStatistics() {
            try {
                // Obter os dados atuais do localStorage
                const schools = getSchools();
                const classes = getClasses();
                const students = getStudents();
                const exams = getExams();
                
                // Atualizar contadores com os dados do localStorage
                document.getElementById('schoolCount').textContent = schools.length;
                document.getElementById('classCount').textContent = classes.length;
                document.getElementById('studentCount').textContent = students.length;
                document.getElementById('examCount').textContent = exams.length;
                
                // Calcular e atualizar a taxa de participação
                document.getElementById('participationRate').textContent = calculateParticipationRate() + '%';
                
                console.log('Estatísticas básicas atualizadas:', {
                    escolas: schools.length,
                    turmas: classes.length,
                    alunos: students.length,
                    provas: exams.length
                });
            } catch (error) {
                console.error('Erro ao atualizar estatísticas básicas:', error);
                // Definir valores padrão em caso de erro
                document.getElementById('schoolCount').textContent = '0';
                document.getElementById('classCount').textContent = '0';
                document.getElementById('studentCount').textContent = '0';
                document.getElementById('examCount').textContent = '0';
                document.getElementById('participationRate').textContent = '0%';
            }
        }
        
        // Função para carregar estatísticas gerais da API
        async function loadStatisticsFromAPI() {
            try {
                console.log('Carregando estatísticas gerais da API...');
                
                const response = await fetch('https://sag-sag.rak8a3.easypanel.host/api/dashboard/statistics', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Estatísticas gerais carregadas com sucesso:', data);
                    
                    // Atualizar contadores com os dados da API usando os nomes de campo corretos
                    document.getElementById('schoolCount').textContent = data.total_escolas || 0;
                    document.getElementById('classCount').textContent = data.total_turmas || 0;
                    document.getElementById('studentCount').textContent = data.total_alunos || 0;
                    document.getElementById('examCount').textContent = data.total_provas || 0;
                    
                    // Exibir o valor da participação exatamente como está no JSON
                    document.getElementById('participationRate').textContent = data.participacao !== null ? data.participacao : 0;
                    
                    return data;
                } else {
                    console.error('Erro ao carregar estatísticas gerais da API:', response.status);
                    throw new Error(`Erro ao carregar estatísticas: ${response.status}`);
                }
            } catch (error) {
                console.error('Erro ao carregar estatísticas gerais da API:', error);
                throw error;
            }
        }
        
        // Função para atualizar estatísticas a partir da API
        function updateStatisticsFromAPI(stats) {
            if (!stats) return;
            
            try {
                // Atualizar os contadores com os dados da API se estiverem disponíveis
                if (stats.total_alunos !== undefined) {
                    document.getElementById('studentCount').textContent = stats.total_alunos;
                }
                
                if (stats.total_provas !== undefined) {
                    document.getElementById('examCount').textContent = stats.total_provas;
                }
                
                if (stats.participacao !== undefined) {
                    document.getElementById('participationRate').textContent = stats.participacao;
                }
                
                console.log('Estatísticas da API atualizadas com sucesso');
            } catch (error) {
                console.error('Erro ao atualizar estatísticas da API:', error);
            }
        }
        
        // Função para carregar escolas da API
        async function loadSchoolsFromAPI() {
            try {
                console.log('Carregando escolas da API...');
                
                const response = await fetch('https://sag-sag.rak8a3.easypanel.host/api/escolas?limit=1000', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Escolas carregadas com sucesso:', data);
                    
                    // Verificar estrutura da resposta e extrair escolas
                    let schools = [];
                    if (Array.isArray(data)) {
                        schools = data;
                    } else if (data && typeof data === 'object') {
                        // Tentar diferentes propriedades possíveis
                        if (Array.isArray(data.escolas)) schools = data.escolas;
                        else if (Array.isArray(data.items)) schools = data.items;
                        else if (Array.isArray(data.data)) schools = data.data;
                        else if (Array.isArray(data.content)) schools = data.content;
                        // Última tentativa: extrair valores que sejam objetos com id e nome
                        else {
                            schools = Object.values(data).filter(item => 
                                item && typeof item === 'object' && item.id && (item.nome || item.name)
                            );
                        }
                    }
                    
                    if (schools.length > 0) {
                        // Limpar escolas existentes e adicionar as novas
                        localStorage.setItem('schools', JSON.stringify([]));
                        
                        // Converter dados da API para o formato local
                        const formattedSchools = schools.map(escola => ({
                            id: escola.id,
                            name: escola.nome || escola.name,
                            region: escola.regiao || escola.region || '',
                            group: escola.grupo || escola.group || ''
                        }));
                        
                        localStorage.setItem('schools', JSON.stringify(formattedSchools));
                        return formattedSchools;
                    } else {
                        console.warn('Nenhuma escola encontrada na resposta da API');
                        return [];
                    }
                } else {
                    console.error('Erro ao carregar escolas da API:', response.status);
                    return [];
                }
            } catch (error) {
                console.error('Erro ao carregar escolas da API:', error);
                return [];
            }
        }
        
        // Função para carregar turmas da API
        async function loadClassesFromAPI() {
            try {
                console.log('Carregando turmas da API...');
                
                const response = await fetch('https://sag-sag.rak8a3.easypanel.host/api/turmas?limit=1000', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Turmas carregadas com sucesso:', data);
                    
                    // Verificar estrutura da resposta e extrair turmas
                    let classes = [];
                    if (Array.isArray(data)) {
                        classes = data;
                    } else if (data && typeof data === 'object') {
                        // Tentar diferentes propriedades possíveis
                        if (Array.isArray(data.turmas)) classes = data.turmas;
                        else if (Array.isArray(data.items)) classes = data.items;
                        else if (Array.isArray(data.data)) classes = data.data;
                        else if (Array.isArray(data.content)) classes = data.content;
                        // Última tentativa: extrair valores que sejam objetos com id e nome
                        else {
                            classes = Object.values(data).filter(item => 
                                item && typeof item === 'object' && item.id && (item.nome || item.name)
                            );
                        }
                    }
                    
                    if (classes.length > 0) {
                        // Limpar turmas existentes e adicionar as novas
                        localStorage.setItem('classes', JSON.stringify([]));
                        
                        // Converter dados da API para o formato local
                        const formattedClasses = classes.map(turma => ({
                            id: turma.id,
                            name: turma.nome || turma.name,
                            series: turma.serie,
                            schoolId: turma.escola_id || turma.schoolId,
                            shift: turma.turno || turma.shift || '',
                            apiId: turma.id
                        }));
                        
                        localStorage.setItem('classes', JSON.stringify(formattedClasses));
                        return formattedClasses;
                    } else {
                        console.warn('Nenhuma turma encontrada na resposta da API');
                        return [];
                    }
                } else {
                    console.error('Erro ao carregar turmas da API:', response.status);
                    return [];
                }
            } catch (error) {
                console.error('Erro ao carregar turmas da API:', error);
                return [];
            }
        }
        
        // Função para carregar alunos da API
        async function loadStudentsFromAPI() {
            try {
                console.log('Carregando alunos da API...');
                
                const response = await fetch('https://sag-sag.rak8a3.easypanel.host/api/alunos', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Alunos carregados com sucesso:', data);
                    
                    // Verificar estrutura da resposta e extrair alunos
                    let students = [];
                    if (Array.isArray(data)) {
                        students = data;
                    } else if (data && typeof data === 'object') {
                        // Tentar diferentes propriedades possíveis
                        if (Array.isArray(data.alunos)) students = data.alunos;
                        else if (Array.isArray(data.items)) students = data.items;
                        else if (Array.isArray(data.data)) students = data.data;
                        else if (Array.isArray(data.content)) students = data.content;
                        // Última tentativa: extrair valores que sejam objetos com id e nome
                        else {
                            students = Object.values(data).filter(item => 
                                item && typeof item === 'object' && item.id && (item.nome || item.name)
                            );
                        }
                    }
                    
                    if (students.length > 0) {
                        // Limpar alunos existentes e adicionar os novos
                        localStorage.setItem('students', JSON.stringify([]));
                        
                        // Converter dados da API para o formato local
                        const formattedStudents = students.map(aluno => ({
                            id: aluno.id,
                            name: aluno.nome || aluno.name,
                            registration: aluno.matricula || aluno.registration,
                            birthdate: aluno.data_nascimento || aluno.birthdate,
                            schoolId: aluno.escola_id || aluno.schoolId,
                            classId: aluno.turma_id || aluno.classId
                        }));
                        
                        localStorage.setItem('students', JSON.stringify(formattedStudents));
                        return formattedStudents;
                    } else {
                        console.warn('Nenhum aluno encontrado na resposta da API');
                        return [];
                    }
                } else {
                    console.error('Erro ao carregar alunos da API:', response.status);
                    return [];
                }
            } catch (error) {
                console.error('Erro ao carregar alunos da API:', error);
                return [];
            }
        }
        
        // Função para carregar provas (simulação por enquanto)
        async function loadExamsFromAPI() {
            // Nota: esta é uma função placeholder até que a API de provas esteja disponível
            // Retorna dados simulados por enquanto
            try {
                console.log('Simulando carregamento de provas...');
                
                // Dados simulados
                const exams = [
                    { id: 1, name: 'Avaliação Diagnóstica - Português', subject: 'Português', grade: '1º Ano', date: '2023-03-15' },
                    { id: 2, name: 'Avaliação Diagnóstica - Matemática', subject: 'Matemática', grade: '1º Ano', date: '2023-03-20' },
                    { id: 3, name: 'Avaliação Bimestral - Português', subject: 'Português', grade: '2º Ano', date: '2023-04-10' },
                    { id: 4, name: 'Avaliação Bimestral - Matemática', subject: 'Matemática', grade: '2º Ano', date: '2023-04-15' },
                    { id: 5, name: 'Avaliação Final - Ciências', subject: 'Ciências', grade: '3º Ano', date: '2023-06-05' },
                ];
                
                localStorage.setItem('exams', JSON.stringify(exams));
                
                return exams;
            } catch (error) {
                console.error('Erro ao simular carregamento de provas:', error);
                // Garantir que há algum dado de prova disponível
                if (!localStorage.getItem('exams')) {
                    localStorage.setItem('exams', JSON.stringify([]));
                }
                return [];
            }
        }
        
        // Função para renderizar gráficos
        function renderDashboardCharts(year = 'all') {
            // Gráfico de desempenho por escolas
            loadSchoolPerformanceChart(year);
            
            // Gráfico de desempenho por avaliação - busca dados da API
            loadExamPerformanceChart(year);
            
            // Gráfico de componentes curriculares - busca dados da API
            loadCurriculumComponentsChart(year);
            
            // Gráfico de evolução por bimestre
            renderEvolutionByTermChart(year);
        }
        
        // Função para popular todos os filtros usando os dados da API
        async function populateFiltersFromAPI() {
            try {
                console.log('Populando filtros com dados da API...');
                
                // Obter dados do localStorage (que foram carregados da API)
                const schools = getSchools();
                const classes = getClasses();
                
                // Verificar se temos dados para popular os filtros
                if (schools.length === 0) {
                    console.warn('Sem dados de escolas para popular filtros');
                }
                
                if (classes.length === 0) {
                    console.warn('Sem dados de turmas para popular filtros');
                }
                
                // Popular regiões primeiro
                await populateRegionsFilter(); // Aguardar carregamento das regiões
                
                // NOVO: Também carregar todos os grupos e escolas no carregamento inicial
                await loadAllGroups();
                await loadAllSchools();
                
                // Outros filtros independentes
                populateGradeFilter();
                populateClassesFilter(classes);
                
                console.log('Filtros populados com sucesso');
            } catch (error) {
                console.error('Erro ao popular filtros:', error);
            }
        }
        
        // NOVA FUNÇÃO: Carregar todos os grupos sem filtrar por região
        async function loadAllGroups() {
            try {
                console.log('Carregando todos os grupos inicialmente...');
                const selector = document.getElementById('filterGroup');
                
                // Limpar opções existentes exceto a primeira
                while (selector.options.length > 1) {
                    selector.remove(1);
                }
                
                const response = await fetch('https://sag-sag.rak8a3.easypanel.host/api/grupos', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ao carregar grupos: ${response.status}`);
                }
                
                const grupos = await response.json();
                console.log('Todos os grupos carregados inicialmente:', grupos);
                
                if (Array.isArray(grupos)) {
                    grupos.forEach(grupo => {
                        const option = document.createElement('option');
                        option.value = grupo.id;
                        option.textContent = grupo.nome;
                        selector.appendChild(option);
                    });
                }
                
                console.log(`Filtro de grupos populado inicialmente com ${grupos.length} grupos`);
            } catch (error) {
                console.error('Erro ao carregar todos os grupos inicialmente:', error);
                
                // Em caso de erro, garantir que há pelo menos uma opção no filtro
                const selector = document.getElementById('filterGroup');
                if (selector.options.length <= 1) {
                    const errorOption = document.createElement('option');
                    errorOption.value = 'all';
                    errorOption.textContent = 'Erro ao carregar grupos';
                    selector.appendChild(errorOption);
                }
            }
        }
        
        // NOVA FUNÇÃO: Carregar todas as escolas sem filtrar
        async function loadAllSchools() {
            try {
                console.log('Carregando todas as escolas inicialmente...');
                const selector = document.getElementById('filterSchool');
                
                // Limpar opções existentes exceto a primeira
                while (selector.options.length > 1) {
                    selector.remove(1);
                }
                
                const response = await fetch('https://sag-sag.rak8a3.easypanel.host/api/escolas?limit=1000', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ao carregar escolas: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Todas as escolas carregadas inicialmente:', data);
                
                // Verificar estrutura da resposta e extrair escolas
                let schools = [];
                
                if (Array.isArray(data)) {
                    schools = data;
                } else if (data && typeof data === 'object') {
                    // Tentar diferentes propriedades possíveis
                    if (Array.isArray(data.escolas)) schools = data.escolas;
                    else if (Array.isArray(data.items)) schools = data.items;
                    else if (Array.isArray(data.data)) schools = data.data;
                    else if (Array.isArray(data.content)) schools = data.content;
                    // Última tentativa: extrair valores que sejam objetos com id e nome
                    else {
                        schools = Object.values(data).filter(item => 
                            item && typeof item === 'object' && item.id && (item.nome || item.name)
                        );
                    }
                }
                
                // Adicionar as escolas ao seletor
                schools.forEach(escola => {
                    const option = document.createElement('option');
                    option.value = escola.id;
                    option.textContent = escola.nome || escola.name;
                    selector.appendChild(option);
                });
                
                console.log(`Filtro de escolas populado inicialmente com ${schools.length} escolas`);
            } catch (error) {
                console.error('Erro ao carregar todas as escolas inicialmente:', error);
                
                // Em caso de erro, garantir que há pelo menos uma opção no filtro
                const selector = document.getElementById('filterSchool');
                if (selector.options.length <= 1) {
                    const errorOption = document.createElement('option');
                    errorOption.value = 'all';
                    errorOption.textContent = 'Erro ao carregar escolas';
                    selector.appendChild(errorOption);
                }
            }
        }
        
        // Função para popular o filtro de escolas com dados da API
        function populateSchoolsFilter(schools = null) {
            try {
                // Usar os dados passados ou obter do localStorage
                const schoolsData = schools || getSchools();
                const selector = document.getElementById('filterSchool');
                
                // Limpar opções existentes exceto a primeira
                while (selector.options.length > 1) {
                    selector.remove(1);
                }
                
                // Adicionar as escolas ao seletor
                schoolsData.forEach(school => {
                    const option = document.createElement('option');
                    option.value = school.id;
                    option.textContent = school.name;
                    selector.appendChild(option);
                });
                
                console.log(`Filtro de escolas populado com ${schoolsData.length} escolas`);
            } catch (error) {
                console.error('Erro ao popular filtro de escolas:', error);
            }
        }
        
        // Função para popular o filtro de regiões com dados da API
        async function populateRegionsFilter() {
            try {
                const selector = document.getElementById('filterRegion');
                
                // Limpar opções existentes exceto a primeira
                while (selector.options.length > 1) {
                    selector.remove(1);
                }

                const response = await fetch('https://sag-sag.rak8a3.easypanel.host/api/regioes', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erro ao carregar regiões: ${response.status}`);
                }

                const regioes = await response.json();
                console.log('Regiões carregadas:', regioes);

                if (Array.isArray(regioes)) {
                    regioes.forEach(regiao => {
                        const option = document.createElement('option');
                        option.value = regiao.id;
                        option.textContent = regiao.nome;
                        selector.appendChild(option);
                    });
                }
                
                console.log(`Filtro de regiões populado com ${regioes.length} regiões`);
            } catch (error) {
                console.error('Erro ao carregar regiões:', error);
            }
        }
        
        // Função para popular o filtro de grupos com dados da API
        async function populateGroupsFilter(regionId = null) {
            try {
                const selector = document.getElementById('filterGroup');
                
                // Limpar opções existentes exceto a primeira
                while (selector.options.length > 1) {
                    selector.remove(1);
                }
                // Construir URL da API com base em parâmetros
                let apiUrl = 'https://sag-sag.rak8a3.easypanel.host/api/grupos';
                if (regionId && regionId !== 'all') {
                    apiUrl += `?regiao_id=${regionId}`;
                }
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    throw new Error(`Erro ao carregar grupos: ${response.status}`);
                }
                const grupos = await response.json();
                console.log('Grupos carregados:', grupos);
                if (Array.isArray(grupos)) {
                    // Se não houver grupos, mostrar mensagem
                    if (grupos.length === 0 && regionId) {
                        const emptyOption = document.createElement('option');
                        emptyOption.value = 'all';
                        emptyOption.textContent = 'Nenhum grupo disponível';
                        selector.appendChild(emptyOption);
                    } else {
                        grupos.forEach(grupo => {
                            const option = document.createElement('option');
                            option.value = grupo.id;
                            option.textContent = grupo.nome;
                            selector.appendChild(option);
                        });
                    }
                }
                
                console.log(`Filtro de grupos populado com ${grupos.length} grupos`);
                
                // Após popular grupos, atualizar o filtro de escolas se necessário
                if (regionId) {
                    // Atualizar escolas com a região e grupo selecionados
                    updateSchoolsFilter();
                }
            } catch (error) {
                console.error('Erro ao carregar grupos:', error);
                
                // Em caso de erro, garantir que há pelo menos uma opção no filtro
                if (selector.options.length <= 1) {
                    const errorOption = document.createElement('option');
                    errorOption.value = 'all';
                    errorOption.textContent = 'Erro ao carregar grupos';
                    selector.appendChild(errorOption);
                }
                
                // Mesmo com erro, tente atualizar escolas se foi chamado com regionId
                if (regionId) {
                    updateSchoolsFilter();
                }
            }
        }
        
        // Função para popular o filtro de séries
        function populateGradeFilter() {
            try {
                // Usar exatamente os valores do enum como value, com labels amigáveis para exibição
                const gradeDisplay = [
                    { value: 'PRIMEIRO_ANO', label: '1º Ano' },
                    { value: 'SEGUNDO_ANO', label: '2º Ano' },
                    { value: 'TERCEIRO_ANO', label: '3º Ano' },
                    { value: 'QUARTO_ANO', label: '4º Ano' },
                    { value: 'QUINTO_ANO', label: '5º Ano' },
                    { value: 'SEXTO_ANO', label: '6º Ano' },
                    { value: 'SETIMO_ANO', label: '7º Ano' },
                    { value: 'OITAVO_ANO', label: '8º Ano' },
                    { value: 'NONO_ANO', label: '9º Ano' },
                    { value: 'PRIMEIRA_SERIE', label: '1ª Série' },
                    { value: 'SEGUNDA_SERIE', label: '2ª Série' },
                    { value: 'TERCEIRA_SERIE', label: '3ª Série' },
                    { value: 'PRIMEIRO_E_SEGUNDO_ANOS', label: '1º e 2º Anos' },
                    { value: 'TERCEIRO_AO_QUINTO_ANO', label: '3º ao 5º Ano' },
                    { value: 'PRIMEIRO_AO_QUINTO_ANO', label: '1º ao 5º Ano' }
                ];
                
                const selector = document.getElementById('filterGrade');
                
                // Limpar opções existentes exceto a primeira
                while (selector.options.length > 1) {
                    selector.remove(1);
                }
                
                // Adicionar as séries ao seletor
                gradeDisplay.forEach(grade => {
                    const option = document.createElement('option');
                    option.value = grade.value;  // Usando diretamente os valores do enum
                    option.textContent = grade.label;
                    selector.appendChild(option);
                });
                
                console.log(`Filtro de séries populado com ${gradeDisplay.length} séries`);
            } catch (error) {
                console.error('Erro ao popular filtro de séries:', error);
            }
        }
        
        // Função para popular o filtro de turmas com dados da API
        function populateClassesFilter(classes = null) {
            try {
                // Usar os dados passados ou obter do localStorage
                const classesData = classes || getClasses();
                const selector = document.getElementById('filterClass');
                
                // Limpar opções existentes exceto a primeira
                while (selector.options.length > 1) {
                    selector.remove(1);
                }
                
                // Adicionar as turmas ao seletor
                classesData.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    selector.appendChild(option);
                });
                
                console.log(`Filtro de turmas populado com ${classesData.length} turmas`);
            } catch (error) {
                console.error('Erro ao popular filtro de turmas:', error);
            }
        }
        
        // Função para atualizar o filtro de turmas quando a escola é alterada
        async function updateClassesFilter() {
            try {
                const schoolId = document.getElementById('filterSchool').value;
                const classSelector = document.getElementById('filterClass');
                
                if (schoolId === 'all') {
                    // Se "Todas as escolas" estiver selecionado, mostrar todas as turmas
                    classSelector.innerHTML = '<option value="all">Todas as turmas</option>';
                    
                    // Carregar todas as turmas da API
                    const classes = await loadClassesFromAPI();
                    populateClassesFilter(classes);
                    return;
                }
                
                // Caso contrário, mostrar indicador de carregamento no filtro de turmas
                classSelector.innerHTML = '<option value="all">Carregando turmas...</option>';
                classSelector.disabled = true;
                
                try {
                    // Buscar turmas da escola selecionada diretamente da API usando nomenclatura consistente
                    const response = await fetch(`https://sag-sag.rak8a3.easypanel.host/api/turmas?escola_id=${schoolId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Erro ao carregar turmas: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('API turmas por escola response:', data);
                    
                    // Verificar estrutura da resposta e extrair turmas
                    let classes = [];
                    
                    if (Array.isArray(data)) {
                        classes = data;
                    } else if (data && typeof data === 'object') {
                        // Tentar diferentes propriedades possíveis
                        if (Array.isArray(data.turmas)) classes = data.turmas;
                        else if (Array.isArray(data.items)) classes = data.items;
                        else if (Array.isArray(data.data)) classes = data.data;
                        else if (Array.isArray(data.content)) classes = data.content;
                        // Última tentativa: extrair valores que sejam objetos com id e nome
                        else {
                            classes = Object.values(data).filter(item => 
                                item && typeof item === 'object' && item.id && (item.nome || item.name)
                            );
                        }
                    }
                    
                    // Resetar o select
                    classSelector.innerHTML = '<option value="all">Todas as turmas</option>';
                    
                    // Se não houver turmas, mostrar mensagem
                    if (!classes || classes.length === 0) {
                        console.warn('Nenhuma turma encontrada para a escola selecionada');
                        classSelector.disabled = false;
                        return;
                    }
                    
                    // Formatar dados das turmas
                    const formattedClasses = classes.map(turma => ({
                        id: turma.id,
                        name: turma.nome || turma.name,
                        series: turma.serie,
                        schoolId: turma.escola_id || turma.schoolId,
                        shift: turma.turno || turma.shift || '',
                        apiId: turma.id
                    }));
                    
                    // Ordenar turmas por nome
                    formattedClasses.sort((a, b) => {
                        return a.name.localeCompare(b.name);
                    });
                    
                    // Adicionar as turmas ao select
                    formattedClasses.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls.id;
                        option.textContent = cls.name;
                        classSelector.appendChild(option);
                    });
                    
                    classSelector.disabled = false;
                    console.log(`Filtro de turmas populado com ${formattedClasses.length} turmas relacionadas à escola ID ${schoolId}`);
                    
                } catch (error) {
                    console.error('Erro ao buscar turmas por escola:', error);
                    classSelector.innerHTML = '<option value="all">Erro ao carregar turmas</option>';
                    classSelector.disabled = false;
                }
                
            } catch (error) {
                console.error('Erro ao atualizar filtro de turmas:', error);
                document.getElementById('filterClass').innerHTML = '<option value="all">Erro ao carregar turmas</option>';
            }
        }
        
        // Update a common function to handle grade parameter conversion
        function addGradeParameterToURL(params, grade) {
            if (grade !== 'all') {
                // Since we're now using the exact enum values in the dropdown,
                // we can simply pass the value directly to the API
                params.append('serie', grade);
                console.log(`Usando valor de enum diretamente: "${grade}"`);
            }
        }
        
        // Função para carregar o gráfico de desempenho por escolas da API
        async function loadSchoolPerformanceChart(year = 'all', region = 'all', group = 'all', school = 'all', grade = 'all', classId = 'all', results = 'all') {
            try {
                console.log('Carregando desempenho por escolas...');
                
                // Construir parâmetros da URL para a API com formato consistente
                const params = new URLSearchParams();
                
                // Incluir apenas os parâmetros específicos solicitados
                if (region !== 'all') params.append('regiao_id', region);
                if (group !== 'all') params.append('grupo_id', group);
                if (school !== 'all') params.append('escola_id', school);
                
                // Usar a função comum para adicionar o parâmetro de série
                addGradeParameterToURL(params, grade);
                
                if (classId !== 'all') params.append('turma_id', classId);
                
                // Adicionar parâmetro para resultados apenas se não for "all"
                if (results !== 'all') {
                    params.append('resultados', results === 'high' ? 'melhores' : 'criticos');
                }
                
                console.log('Parâmetros para API de desempenho escolar:', params.toString());
                
                // Exibir indicador de carregamento no gráfico
                const chartCanvas = document.getElementById('schoolPerformanceChart');
                const chartInstance = Chart.getChart(chartCanvas);
                if (chartInstance) {
                    chartInstance.destroy();
                }
                
                // Exibir indicador de carregamento no gráfico
                const ctx = chartCanvas.getContext('2d');
                ctx.textAlign = 'center';
                ctx.fillStyle = '#888';
                ctx.font = '12px Arial';
                ctx.fillText('Carregando dados...', chartCanvas.width / 2, chartCanvas.height / 2);
                
                // Fazer a requisição para a API
                const response = await fetch(`https://sag-sag.rak8a3.easypanel.host/api/dashboard/school-performance?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Desempenho por escolas carregado com sucesso:', data);
                    
                    // Verificar se a resposta é um array
                    if (Array.isArray(data)) {
                        // Filtrar escolas com dados de desempenho válidos (não null)
                        const schoolsWithData = data.filter(item => item.media_desempenho !== null);
                        
                        // Se não houver escolas com dados, mostrar mensagem
                        if (schoolsWithData.length === 0) {
                            displayNoDataChart(chartCanvas, 'Não há dados de desempenho disponíveis para as escolas');
                            return;
                        }
                        
                        // Ordenar escolas por desempenho (do maior para o menor)
                        schoolsWithData.sort((a, b) => b.media_desempenho - a.media_desempenho);
                        
                        // Limitar a um número máximo de escolas para melhor visualização (top 15)
                        const topSchools = schoolsWithData.slice(0, 15);
                        
                        // Preparar dados para o gráfico
                        const schoolLabels = topSchools.map(item => item.escola_nome);
                        const schoolPerformanceData = topSchools.map(item => item.media_desempenho);
                        
                        // Definir cores baseadas no desempenho
                        const backgroundColor = topSchools.map(item => {
                            const performance = item.media_desempenho;
                            if (performance >= 7) return 'rgba(34, 197, 94, 0.6)'; // Verde para bom desempenho
                            if (performance < 6) return 'rgba(239, 68, 68, 0.6)'; // Vermelho para desempenho crítico
                            return 'rgba(234, 179, 8, 0.6)'; // Amarelo para desempenho médio
                        });
                        
                        const borderColor = topSchools.map(item => {
                            const performance = item.media_desempenho;
                            if (performance >= 7) return 'rgb(22, 163, 74)'; // Verde para bom desempenho
                            if (performance < 6) return 'rgb(220, 38, 38)'; // Vermelho para desempenho crítico
                            return 'rgb(202, 138, 4)'; // Amarelo para desempenho médio
                        });
                        
                        // Criar o gráfico com os dados da API
                        new Chart(chartCanvas, {
                            type: 'bar',
                            data: {
                                labels: schoolLabels,
                                datasets: [{
                                    label: 'Média de Desempenho',
                                    data: schoolPerformanceData,
                                    backgroundColor: backgroundColor,
                                    borderColor: borderColor,
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: 'Desempenho por Escolas (Top 15)'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const dataIndex = context.dataIndex;
                                                const totalAlunos = topSchools[dataIndex].total_alunos || 0;
                                                const totalTurmas = topSchools[dataIndex].total_turmas || 0;
                                                const totalDesempenhos = topSchools[dataIndex].total_desempenhos || 0;
                                                
                                                return [
                                                    `Média: ${context.formattedValue}`, 
                                                    `Total de alunos: ${totalAlunos}`,
                                                    `Total de turmas: ${totalTurmas}`,
                                                    `Total de desempenhos: ${totalDesempenhos}`
                                                ];
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 10,
                                        title: {
                                            display: true,
                                            text: 'Média de Desempenho'
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'Escolas'
                                        },
                                        ticks: {
                                            maxRotation: 45,
                                            minRotation: 45
                                        }
                                    }
                                }
                            }
                        });
                    } else {
                        console.error('Resposta da API não é um array:', data);
                        displayErrorChart(chartCanvas, 'Formato de resposta inválido');
                    }
                } else {
                    console.error('Erro ao carregar desempenho por escolas:', response.status);
                    displayErrorChart(chartCanvas, `Erro ao carregar dados (${response.status})`);
                }
            } catch (error) {
                console.error('Erro ao carregar desempenho por escolas:', error);
                const chartCanvas = document.getElementById('schoolPerformanceChart');
                displayErrorChart(chartCanvas, error.message);
            }
        }
        
        // Função auxiliar para exibir mensagem de erro em um gráfico
        function displayErrorChart(canvas, errorMessage) {
            const ctx = canvas.getContext('2d');
            const chartInstance = Chart.getChart(canvas);
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Criar um gráfico vazio com mensagem de erro
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Erro'],
                    datasets: [{
                        label: 'Erro',
                        data: [0],
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgb(255, 99, 132)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: `Erro ao carregar dados: ${errorMessage}`
                        }
                    },
                    scales: {
                        y: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Função para aplicar filtros
        function applyFilters() {
            const yearFilter = document.getElementById('filterYear').value;
            const regionFilter = document.getElementById('filterRegion').value;
            const groupFilter = document.getElementById('filterGroup').value;
            const schoolFilter = document.getElementById('filterSchool').value;
            const gradeFilter = document.getElementById('filterGrade').value;
            const classFilter = document.getElementById('filterClass').value;
            const resultsFilter = document.getElementById('filterResults').value;
            
            // Mostrar apenas os parâmetros que serão enviados para a API
            const logParams = { 
                regiao_id: regionFilter !== 'all' ? regionFilter : undefined, 
                grupo_id: groupFilter !== 'all' ? groupFilter : undefined,
                escola_id: schoolFilter !== 'all' ? schoolFilter : undefined, 
                serie: gradeFilter !== 'all' ? gradeFilter : undefined,
                turma_id: classFilter !== 'all' ? classFilter : undefined
            };
            
            // Adicionar resultados apenas se não for "all"
            if (resultsFilter !== 'all') {
                logParams.resultados = resultsFilter === 'high' ? 'melhores' : 'criticos';
            }
            
            // Filtrar valores indefinidos para melhor visualização
            const cleanLogParams = Object.fromEntries(
                Object.entries(logParams).filter(([_, v]) => v !== undefined)
            );
            
            console.log('Filtros aplicados:', cleanLogParams);
            
            // Mostrar alerta visual de que filtros estão sendo aplicados
            const mainContent = document.querySelector('main');
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed top-4 right-4 bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded shadow-md z-50';
            alertDiv.innerHTML = '<i class="fas fa-filter mr-2"></i> Aplicando filtros, aguarde...';
            document.body.appendChild(alertDiv);
            
            // Remover o alerta após 3 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
            
            // Exibir indicadores de carregamento
            document.getElementById('schoolPerformanceChart').getContext('2d').canvas.style.opacity = '0.5';
            document.getElementById('curriculumComponentsChart').getContext('2d').canvas.style.opacity = '0.5';
            document.getElementById('evolutionByTermChart').getContext('2d').canvas.style.opacity = '0.5';
            document.getElementById('bnccSkillsList').innerHTML = '<div class="col-span-full text-center py-8"><i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i><p class="mt-2 text-gray-500">Carregando dados...</p></div>';
            document.getElementById('studentRankingList').innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i> Carregando ranking de alunos...</td></tr>';
            
            // Resetar páginas atuais ao aplicar novos filtros
            currentPage = 1;
            currentRankPage = 1;
            
            // Recarregar os gráficos e tabelas com base nos filtros
            loadSchoolPerformanceChart(yearFilter, regionFilter, groupFilter, schoolFilter, gradeFilter, classFilter, resultsFilter);
            loadExamPerformanceChart(yearFilter, regionFilter, groupFilter, schoolFilter, gradeFilter, classFilter, resultsFilter);
            loadCurriculumComponentsChart(yearFilter, regionFilter, groupFilter, schoolFilter, gradeFilter, classFilter, resultsFilter);
            renderEvolutionByTermChart(yearFilter, schoolFilter, resultsFilter);
            loadBnccSkills(yearFilter, regionFilter, groupFilter, schoolFilter, gradeFilter, classFilter, resultsFilter, 1); // Sempre começar na página 1
            loadStudentRanking(yearFilter, regionFilter, groupFilter, schoolFilter, gradeFilter, classFilter, resultsFilter, 1); // Sempre começar na página 1
            
            // Restaurar opacidade dos gráficos após a renderização
            setTimeout(() => {
                document.getElementById('schoolPerformanceChart').getContext('2d').canvas.style.opacity = '1';
                document.getElementById('curriculumComponentsChart').getContext('2d').canvas.style.opacity = '1';
                document.getElementById('evolutionByTermChart').getContext('2d').canvas.style.opacity = '1';
            }, 500);
        }
        
        // Função para renderizar o gráfico de componentes curriculares
        function renderCurriculumComponentsChart(year = 'all', school = 'all', results = 'all') {
            // Dados de exemplo para componentes curriculares
            const components = ['Língua Portuguesa', 'Matemática', 'Ciências', 'História', 'Geografia'];
            
            // Simular dados diferentes com base nos filtros
            let performanceData;
            
            if (results === 'high') {
                performanceData = components.map(() => Math.floor(Math.random() * 15) + 75); // 75-90%
            } else if (results === 'low') {
                performanceData = components.map(() => Math.floor(Math.random() * 25) + 40); // 40-65%
            } else {
                performanceData = components.map(() => Math.floor(Math.random() * 50) + 40); // 40-90%
            }
            
            // Verificar se o canvas já tem um gráfico e destruí-lo
            const chartCanvas = document.getElementById('curriculumComponentsChart');
            const chartInstance = Chart.getChart(chartCanvas);
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Criar novo gráfico de colunas
            new Chart(chartCanvas, {
                type: 'bar',
                data: {
                    labels: components,
                    datasets: [{
                        label: 'Desempenho (%)',
                        data: performanceData,
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(153, 102, 255, 0.6)'
                        ],
                        borderColor: [
                            'rgb(54, 162, 235)',
                            'rgb(255, 99, 132)',
                            'rgb(75, 192, 192)',
                            'rgb(255, 206, 86)',
                            'rgb(153, 102, 255)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Desempenho por Componente Curricular'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Desempenho (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Componentes Curriculares'
                            }
                        }
                    }
                }
            });
        }
        
        // Função para renderizar o gráfico de evolução por bimestre
        function renderEvolutionByTermChart(year = 'all', school = 'all', results = 'all') {
            // Dados de exemplo para bimestres
            const terms = ['1º Bimestre', '2º Bimestre', '3º Bimestre', '4º Bimestre'];
            
            // Dados para diferentes componentes curriculares por bimestre
            const components = ['Língua Portuguesa', 'Matemática', 'Ciências', 'História', 'Geografia'];
            const datasets = [];
            
            // Cores para os diferentes componentes
            const colors = [
                { bg: 'rgba(54, 162, 235, 0.6)', border: 'rgb(54, 162, 235)' },
                { bg: 'rgba(255, 99, 132, 0.6)', border: 'rgb(255, 99, 132)' },
                { bg: 'rgba(75, 192, 192, 0.6)', border: 'rgb(75, 192, 192)' },
                { bg: 'rgba(255, 206, 86, 0.6)', border: 'rgb(255, 206, 86)' },
                { bg: 'rgba(153, 102, 255, 0.6)', border: 'rgb(153, 102, 255)' }
            ];
            
            // Simular dados de evolução para cada componente
            components.forEach((component, index) => {
                // Gerar dados com tendência de crescimento ao longo dos bimestres
                let basePerformance;
                if (results === 'high') {
                    basePerformance = 70; // Começa mais alto para melhores resultados
                } else if (results === 'low') {
                    basePerformance = 40; // Começa mais baixo para resultados críticos
                } else {
                    basePerformance = 50; // Valor intermediário para todos os resultados
                }
                
                // Gerar dados com leve tendência de aumento por bimestre
                const termData = terms.map((_, termIndex) => {
                    // Aumento gradual de desempenho com variação aleatória
                    const increase = termIndex * 5; // 5% de aumento médio por bimestre
                    const randomFactor = Math.floor(Math.random() * 10) - 5; // Variação de -5 a +5
                    return Math.min(Math.max(basePerformance + increase + randomFactor, 0), 100); // Garantir entre 0-100
                });
                
                datasets.push({
                    label: component,
                    data: termData,
                    backgroundColor: colors[index].bg,
                    borderColor: colors[index].border,
                    borderWidth: 2,
                    tension: 0.1
                });
            });
            
            // Verificar se o canvas já tem um gráfico e destruí-lo
            const chartCanvas = document.getElementById('evolutionByTermChart');
            const chartInstance = Chart.getChart(chartCanvas);
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Criar novo gráfico de linha
            new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: terms,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Evolução do Desempenho por Bimestre'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Desempenho (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Bimestres'
                            }
                        }
                    }
                }
            });
        }
        
        // Variáveis para controle de paginação
        let currentPage = 1;
        const itemsPerPage = 20;
        let totalBnccItems = 0; // Total de itens disponíveis no servidor
        
        // Função para carregar dados de habilidades BNCC da API
        async function loadBnccSkills(year = 'all', region = 'all', group = 'all', school = 'all', grade = 'all', classId = 'all', results = 'all', page = 1) {
            // Exibir indicador de carregamento
            document.getElementById('bnccSkillsList').innerHTML = '<div class="col-span-full text-center py-8"><i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i><p class="mt-2 text-gray-500">Carregando habilidades...</p></div>';
            
            try {
                // Construir parâmetros da URL para a API com formato consistente
                const params = new URLSearchParams();
                
                // Incluir apenas os parâmetros específicos solicitados
                if (region !== 'all') params.append('regiao_id', region);
                if (group !== 'all') params.append('grupo_id', group);
                if (school !== 'all') params.append('escola_id', school);
                
                // Usar a função comum para adicionar o parâmetro de série
                addGradeParameterToURL(params, grade);
                
                if (classId !== 'all') params.append('turma_id', classId);
                
                // Adicionar parâmetro para resultados apenas se não for "all"
                if (results !== 'all') {
                    params.append('resultados', results === 'high' ? 'melhores' : 'criticos');
                }
                
                // Adicionar parâmetros de paginação
                params.append('page', page);
                params.append('size', itemsPerPage);
                
                console.log('Parâmetros para API de habilidades BNCC:', params.toString());
                
                const response = await fetch(`https://sag-sag.rak8a3.easypanel.host/api/dashboard/bncc-skills?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Habilidades BNCC carregadas com sucesso:', data);
                    
                    // Verificar formato da resposta paginada
                    if (data && (data.content || data.items || data.data)) {
                        // Extrair conteúdo e informações de paginação
                        const content = data.content || data.items || data.data || [];
                        currentPage = data.number !== undefined ? data.number + 1 : (data.page || page);
                        totalBnccItems = data.totalElements || data.total || data.count || 0;
                        
                        // Formatar os dados para o formato usado pela UI
                        const formattedSkills = content.map(skill => {
                            // Validar e formatar o código da habilidade
                            const code = skill.bncc_codigo?.trim() || skill.codigo?.trim() || skill.code?.trim();
                            if (!code) {
                                console.warn('Habilidade sem código:', skill);
                            }

                            // Se a performance/média for null, definir como 'N/A'
                            const performance = skill.percentual_acertos !== undefined 
                                ? skill.percentual_acertos 
                                : (skill.media !== null ? skill.media : 'N/A');
                            
                            return {
                                code: code || 'EF00XX00', // Código padrão se não houver código
                                description: skill.bncc_descricao || skill.descricao || skill.description || 'Descrição não disponível',
                                performance: performance, 
                                totalQuestions: skill.total_questoes || skill.totalQuestions || 0,
                                component: code ? extractComponentFromCode(code) : 'Não especificado',
                                grade: code ? extractGradeFromCode(code) : 'Não especificado',
                                evaluation: `Média de ${skill.total_questoes || skill.totalQuestions || 0} questões`,
                                // Outros campos que possam existir na resposta
                                componenteId: skill.componente_id || '',
                                componenteNome: skill.componente_curricular || skill.componente_nome || '',
                                turmaId: skill.turma_id || '',
                                turmaNome: skill.turma_nome || '',
                                escolaId: skill.escola_id || '',
                                escolaNome: skill.escola_nome || ''
                            };
                        });
                        
                        // Armazenar os dados paginados e exibir
                        filteredSkills = formattedSkills;
                        displayBnccSkills();
                        updatePagination();
                    } else if (Array.isArray(data)) {
                        // Compatibilidade com APIs que ainda não implementaram paginação
                        console.warn('API retornou array sem paginação, usando dados para simular paginação');
                        
                        // Formatar os dados para o formato usado pela UI
                        const formattedSkills = data.map(skill => {
                            // Validar e formatar o código da habilidade
                            const code = skill.bncc_codigo?.trim() || skill.codigo?.trim() || skill.code?.trim();
                            if (!code) {
                                console.warn('Habilidade sem código:', skill);
                            }

                            // Se a performance/média for null, definir como 'N/A'
                            const performance = skill.percentual_acertos !== undefined 
                                ? skill.percentual_acertos 
                                : (skill.media !== null ? skill.media : 'N/A');
                            
                            return {
                                code: code || 'EF00XX00', // Código padrão se não houver código
                                description: skill.bncc_descricao || skill.descricao || skill.description || 'Descrição não disponível',
                                performance: performance, 
                                totalQuestions: skill.total_questoes || skill.totalQuestions || 0,
                                component: code ? extractComponentFromCode(code) : 'Não especificado',
                                grade: code ? extractGradeFromCode(code) : 'Não especificado',
                                evaluation: `Média de ${skill.total_questoes || skill.totalQuestions || 0} questões`,
                                // Outros campos que possam existir na resposta
                                componenteId: skill.componente_id || '',
                                componenteNome: skill.componente_curricular || skill.componente_nome || '',
                                turmaId: skill.turma_id || '',
                                turmaNome: skill.turma_nome || '',
                                escolaId: skill.escola_id || '',
                                escolaNome: skill.escola_nome || ''
                            };
                        });
                        
                        // Aplicar filtros adicionais no cliente (para manter compatibilidade com a interface existente)
                        bnccSkillsData = formattedSkills;
                        totalBnccItems = formattedSkills.length;
                        
                        // Filtrar localmente para compatibilidade
                        if (results === 'high') {
                            filteredSkills = formattedSkills.filter(skill => skill.performance !== 'N/A' && skill.performance >= 70);
                        } else if (results === 'low') {
                            filteredSkills = formattedSkills.filter(skill => skill.performance !== 'N/A' && skill.performance < 60);
                        } else {
                            filteredSkills = formattedSkills;
                        }
                        
                        // Simular paginação local
                        const startIndex = (page - 1) * itemsPerPage;
                        const endIndex = Math.min(startIndex + itemsPerPage, filteredSkills.length);
                        filteredSkills = filteredSkills.slice(startIndex, endIndex);
                        
                        // Exibir os dados e atualizar paginação
                        displayBnccSkills();
                        updatePagination();
                    } else {
                        console.error('Resposta da API não é um formato paginado ou array:', data);
                        document.getElementById('bnccSkillsList').innerHTML = '<div class="col-span-full text-center py-8 text-red-500">Erro ao carregar habilidades. Formato de resposta inválido.</div>';
                    }
                } else {
                    console.error('Erro ao carregar habilidades BNCC da API:', response.status);
                    document.getElementById('bnccSkillsList').innerHTML = '<div class="col-span-full text-center py-8 text-red-500">Erro ao carregar habilidades. Status: ' + response.status + '</div>';
                }
            } catch (error) {
                console.error('Erro ao carregar habilidades BNCC:', error);
                document.getElementById('bnccSkillsList').innerHTML = '<div class="col-span-full text-center py-8 text-red-500">Erro ao carregar habilidades: ' + error.message + '</div>';
            }
        }
        
        // Função auxiliar para extrair o componente curricular do código da habilidade
        function extractComponentFromCode(code) {
            try {
                if (!code || typeof code !== 'string') {
                    return 'Não especificado';
                }
                // Exemplo: EF69LP01 -> LP (Língua Portuguesa)
                const match = code.match(/[A-Z]{2}/);
                if (!match) {
                    return 'Não especificado';
                }
                const componentCode = match[0];
                const components = {
                    'LP': 'Língua Portuguesa',
                    'MA': 'Matemática',
                    'CI': 'Ciências',
                    'HI': 'História',
                    'GE': 'Geografia',
                    'EF': 'Educação Física',
                    'AR': 'Arte',
                    'ER': 'Ensino Religioso',
                    'LI': 'Língua Inglesa'
                };
                return components[componentCode] || componentCode;
            } catch (error) {
                console.warn('Erro ao extrair componente do código:', error);
                return 'Não especificado';
            }
        }
        
        // Função auxiliar para extrair o ano escolar do código da habilidade
        function extractGradeFromCode(code) {
            try {
                if (!code || typeof code !== 'string') {
                    return 'Não especificado';
                }
                // Exemplo: EF69LP01 -> 6º e 9º anos
                const match = code.match(/EF(\d+)/);
                if (!match) {
                    return 'Não especificado';
                }
                const years = match[1];
                if (years.length === 2) {
                    return `${years[0]}º ao ${years[1]}º ano`;
                } else if (years.length === 1) {
                    return `${years}º ano`;
                }
                return 'Não especificado';
            } catch (error) {
                console.warn('Erro ao extrair ano do código:', error);
                return 'Não especificado';
            }
        }

        // Função para filtrar habilidades por críticas ou melhores
        function filterBnccSkills(type) {
            try {
                // Mostrar indicador de carregamento
                document.getElementById('bnccSkillsList').innerHTML = '<div class="col-span-full text-center py-8"><i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i><p class="mt-2 text-gray-500">Carregando habilidades...</p></div>';
                
                // Obter os filtros atuais do topo
                const yearFilter = document.getElementById('filterYear').value;
                const regionFilter = document.getElementById('filterRegion').value;
                const groupFilter = document.getElementById('filterGroup').value;
                const schoolFilter = document.getElementById('filterSchool').value;
                const gradeFilter = document.getElementById('filterGrade').value;
                const classFilter = document.getElementById('filterClass').value;
                
                // Definir o tipo de resultados e carregar da API
                const resultsFilter = type === 'critical' ? 'low' : (type === 'best' ? 'high' : 'all');
                
                // Resetar para a primeira página ao aplicar um novo filtro
                currentPage = 1;
                
                // Carregar dados com os filtros aplicados
                loadBnccSkills(
                    yearFilter, 
                    regionFilter, 
                    groupFilter, 
                    schoolFilter, 
                    gradeFilter, 
                    classFilter, 
                    resultsFilter, 
                    currentPage
                );
            } catch (error) {
                console.error('Erro ao filtrar habilidades BNCC:', error);
                document.getElementById('bnccSkillsList').innerHTML = '<div class="col-span-full text-center py-8 text-red-500">Erro ao filtrar habilidades: ' + error.message + '</div>';
            }
        }
        
        // Função para exibir habilidades BNCC
        function displayBnccSkills() {
            const container = document.getElementById('bnccSkillsList');
            container.innerHTML = '';
            
            // Calcular índices para a página atual com base nos dados paginados do servidor
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = startIndex + filteredSkills.length - 1;
            
            // Atualizar informações de paginação
            document.getElementById('startRange').textContent = filteredSkills.length > 0 ? startIndex : 0;
            document.getElementById('endRange').textContent = endIndex;
            document.getElementById('totalItems').textContent = totalBnccItems;
            
            // Se não houver resultados
            if (filteredSkills.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'col-span-full text-center py-8 text-gray-500';
                emptyMessage.textContent = 'Nenhuma habilidade encontrada';
                container.appendChild(emptyMessage);
                return;
            }
            
            // Adicionar os botões de habilidades
            for (let i = 0; i < filteredSkills.length; i++) {
                const skill = filteredSkills[i];
                
                // Definir classe de desempenho e cor
                let performanceClass = '';
                let bgColorClass = '';
                let borderColorClass = '';
                let performanceDisplay = '';
                
                if (skill.performance === 'N/A') {
                    performanceClass = 'text-gray-500';
                    bgColorClass = 'bg-gray-100';
                    borderColorClass = 'border-gray-300';
                    performanceDisplay = 'N/A';
                } else {
                    if (skill.performance >= 70) {
                        performanceClass = 'text-green-700';
                        bgColorClass = 'bg-green-100';
                        borderColorClass = 'border-green-300';
                    } else if (skill.performance < 60) {
                        performanceClass = 'text-red-700';
                        bgColorClass = 'bg-red-100';
                        borderColorClass = 'border-red-300';
                    } else {
                        performanceClass = 'text-yellow-700';
                        bgColorClass = 'bg-yellow-100';
                        borderColorClass = 'border-yellow-300';
                    }
                    performanceDisplay = `${skill.performance}%`;
                }
                
                // Criar o botão de habilidade
                const skillButton = document.createElement('button');
                skillButton.className = `skill-btn w-full flex flex-col items-center justify-center p-3 rounded-lg border ${borderColorClass} ${bgColorClass} transition-all hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500`;
                skillButton.setAttribute('data-code', skill.code);
                skillButton.setAttribute('data-performance', skill.performance);
                skillButton.setAttribute('data-component', skill.component);
                skillButton.setAttribute('data-grade', skill.grade);
                skillButton.setAttribute('data-description', skill.description);
                skillButton.setAttribute('data-evaluation', skill.evaluation);
                skillButton.setAttribute('data-total-questions', skill.totalQuestions || 0);
                
                skillButton.innerHTML = `
                    <span class="text-gray-900 font-bold text-lg">${skill.code}</span>
                    <span class="text-xl font-bold ${performanceClass} mt-1">${performanceDisplay}</span>
                    ${skill.totalQuestions ? `<span class="text-xs text-gray-500 mt-1">${skill.totalQuestions} questões</span>` : ''}
                `;
                
                // Adicionar evento ao botão
                skillButton.addEventListener('click', () => showSkillDetails(skill));
                
                container.appendChild(skillButton);
            }
        }
        
        // Função para mostrar detalhes da habilidade ao clicar
        function showSkillDetails(skill) {
            // Verificar se a skill existe
            if (!skill) {
                console.error('Erro: Habilidade não definida');
                return;
            }
            
            // Definir classe de desempenho e display
            let performanceClass = '';
            let performanceDisplay = '';
            
            if (skill.performance === 'N/A' || skill.performance === undefined || skill.performance === null) {
                performanceClass = 'text-gray-500';
                performanceDisplay = 'N/A';
            } else {
                if (skill.performance >= 70) {
                    performanceClass = 'text-green-600';
                } else if (skill.performance < 60) {
                    performanceClass = 'text-red-600';
                } else {
                    performanceClass = 'text-yellow-600';
                }
                performanceDisplay = `${skill.performance}%`;
            }
            
            // Buscar histórico de desempenho para esta habilidade se disponível
            // Nota: Talvez precise de uma nova rota de API para obter histórico
            const historyData = skill.history || getSkillPerformanceHistory(skill.code);
            
            // Verificar campos obrigatórios e fornecer valores padrão
            const code = skill.code || 'Código não disponível';
            const description = skill.description || 'Descrição não disponível';
            const component = skill.component || 'Componente não disponível';
            const grade = skill.grade || 'Ano não disponível';
            const totalQuestions = skill.totalQuestions || 0;
            
            // Campos opcionais
            const componenteNome = skill.componenteNome || '';
            const escolaNome = skill.escolaNome || '';
            const turmaNome = skill.turmaNome || '';
            
            // Criar modal para mostrar detalhes
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
                    <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">
                            Detalhes da Habilidade
                        </h3>
                        <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-500" id="closeSkillModal">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-lg font-bold">${code}</span>
                            <span class="text-lg ${performanceClass} font-bold">${performanceDisplay}</span>
                        </div>
                        <dl class="grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-2">
                            <div class="sm:col-span-1">
                                <dt class="text-sm font-medium text-gray-500">Componente</dt>
                                <dd class="mt-1 text-sm text-gray-900">${component}</dd>
                            </div>
                            <div class="sm:col-span-1">
                                <dt class="text-sm font-medium text-gray-500">Ano</dt>
                                <dd class="mt-1 text-sm text-gray-900">${grade}</dd>
                            </div>
                            <div class="sm:col-span-2">
                                <dt class="text-sm font-medium text-gray-500">Descrição</dt>
                                <dd class="mt-1 text-sm text-gray-900">${description}</dd>
                            </div>
                            <div class="sm:col-span-1">
                                <dt class="text-sm font-medium text-gray-500">Total de Questões</dt>
                                <dd class="mt-1 text-sm text-gray-900">${totalQuestions || 'Não disponível'}</dd>
                            </div>
                            <div class="sm:col-span-1">
                                <dt class="text-sm font-medium text-gray-500">Média de Desempenho</dt>
                                <dd class="mt-1 text-sm ${performanceClass} font-medium">${performanceDisplay}</dd>
                            </div>
                            ${componenteNome ? `
                            <div class="sm:col-span-1">
                                <dt class="text-sm font-medium text-gray-500">Componente Curricular</dt>
                                <dd class="mt-1 text-sm text-gray-900">${componenteNome}</dd>
                            </div>` : ''}
                            ${escolaNome ? `
                            <div class="sm:col-span-1">
                                <dt class="text-sm font-medium text-gray-500">Escola</dt>
                                <dd class="mt-1 text-sm text-gray-900">${escolaNome}</dd>
                            </div>` : ''}
                            ${turmaNome ? `
                            <div class="sm:col-span-1">
                                <dt class="text-sm font-medium text-gray-500">Turma</dt>
                                <dd class="mt-1 text-sm text-gray-900">${turmaNome}</dd>
                            </div>` : ''}
                        </dl>
                        
                        <!-- Seção de evolução da habilidade -->
                        <div class="mt-6 sm:col-span-2">
                            <h4 class="text-base font-medium text-gray-700 mb-3">Evolução do Desempenho</h4>
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                ${historyData && historyData.length > 1 
                                    ? '<canvas id="skillEvolutionChart" height="250"></canvas>'
                                    : '<p class="text-center text-gray-500 py-8">Não há dados históricos suficientes para exibir a evolução.</p>'
                                }
                            </div>
                        </div>
                        
                        <!-- Tabela com histórico detalhado -->
                        ${historyData && historyData.length > 0 ? `
                        <div class="mt-6">
                            <h4 class="text-base font-medium text-gray-700 mb-3">Histórico Detalhado</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avaliação</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Desempenho</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Evolução</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${historyData.map((item, index) => {
                                            let evolutionText = '';
                                            let evolutionClass = '';
                                            let diff;
                                            
                                            if (index > 0) {
                                                if (item.performance === 'N/A' || historyData[index - 1].performance === 'N/A') {
                                                    evolutionText = 'N/A';
                                                    evolutionClass = 'text-gray-500';
                                                } else {
                                                    diff = item.performance - historyData[index - 1].performance;
                                                    evolutionText = diff > 0 ? `+${diff.toFixed(1)}%` : `${diff.toFixed(1)}%`;
                                                    evolutionClass = diff > 0 ? 'text-green-600' : (diff < 0 ? 'text-red-600' : 'text-gray-600');
                                                }
                                            } else {
                                                evolutionText = 'Primeira avaliação';
                                                evolutionClass = 'text-gray-600';
                                            }

                                            let itemPerformanceClass = '';
                                            let itemPerformanceDisplay = '';
                                            
                                            if (item.performance === 'N/A' || item.performance === null || item.performance === undefined) {
                                                itemPerformanceClass = 'text-gray-500';
                                                itemPerformanceDisplay = 'N/A';
                                            } else {
                                                if (item.performance >= 70) {
                                                    itemPerformanceClass = 'text-green-600';
                                                } else if (item.performance < 60) {
                                                    itemPerformanceClass = 'text-red-600';
                                                } else {
                                                    itemPerformanceClass = 'text-yellow-600';
                                                }
                                                itemPerformanceDisplay = `${item.performance}%`;
                                            }
                                            
                                            // Garantir que evaluation e date não sejam undefined
                                            const evaluation = item.evaluation || 'Avaliação não disponível';
                                            const date = item.date || 'Data não disponível';
                                            
                                            return `
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${evaluation}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${itemPerformanceClass}">${itemPerformanceDisplay}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${evolutionClass}">
                                                    ${evolutionText}
                                                    ${index > 0 && item.performance !== 'N/A' && historyData[index - 1].performance !== 'N/A' && diff !== 0 ? 
                                                        `<i class="fas fa-${diff > 0 ? 'arrow-up' : 'arrow-down'} ml-1"></i>` : ''}
                                                </td>
                                            </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="px-4 py-3 bg-gray-50 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                                id="cancelSkillModal">
                            Fechar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Renderizar o gráfico de evolução se houver dados suficientes
            if (historyData && historyData.length > 1) {
                setTimeout(() => {
                    renderSkillEvolutionChart(historyData);
                }, 100);
            }
            
            // Adicionar eventos para fechar o modal
            document.getElementById('closeSkillModal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            document.getElementById('cancelSkillModal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        // Função para obter o histórico de desempenho de uma habilidade
        function getSkillPerformanceHistory(skillCode) {
            // Verificar se o código da habilidade é válido
            if (!skillCode || skillCode === 'Código não disponível') {
                console.warn('Código de habilidade inválido ou não disponível:', skillCode);
                return [];
            }

            try {
                // Obter todas as habilidades com o mesmo código
                const historyData = filteredSkills.filter(skill => skill.code === skillCode);
                
                if (!historyData || historyData.length === 0) {
                    console.log('Nenhum histórico encontrado para a habilidade:', skillCode);
                    return [];
                }
                
                // Extrair data da string de avaliação
                // Formato: "Nome da Prova - Nome da Escola (Ano Letivo)"
                historyData.forEach(item => {
                    if (!item.evaluation) {
                        item.date = 'Data não disponível';
                        return;
                    }
                    
                    try {
                        const match = item.evaluation.match(/(.*) - (.*) \((.*)\)/);
                        if (match) {
                            const examName = match[1];
                            const schoolName = match[2];
                            const year = match[3];
                            
                            // Gerar uma data simulada
                            const dateParts = year.split('-');
                            const baseYear = dateParts[0];
                            // Gerar um mês e dia aleatório para simular a data da avaliação
                            const month = Math.floor(Math.random() * 12) + 1;
                            const day = Math.floor(Math.random() * 28) + 1;
                            
                            item.date = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${baseYear}`;
                        } else {
                            item.date = 'Data não disponível';
                        }
                    } catch (error) {
                        console.error('Erro ao processar data de avaliação:', error);
                        item.date = 'Data não disponível';
                    }
                });
                
                // Ordenar do mais antigo para o mais recente
                historyData.sort((a, b) => {
                    if (!a.date || a.date === 'Data não disponível') return -1;
                    if (!b.date || b.date === 'Data não disponível') return 1;
                    
                    try {
                        const dateA = new Date(a.date.split('/').reverse().join('-'));
                        const dateB = new Date(b.date.split('/').reverse().join('-'));
                        return dateA - dateB;
                    } catch (error) {
                        console.error('Erro ao ordenar datas:', error);
                        return 0;
                    }
                });
                
                return historyData;
            } catch (error) {
                console.error('Erro ao obter histórico de desempenho:', error);
                return [];
            }
        }
        
        // Função para renderizar o gráfico de evolução da habilidade
        function renderSkillEvolutionChart(historyData) {
            try {
                // Verificar se historyData é válido
                if (!historyData || !Array.isArray(historyData) || historyData.length < 1) {
                    console.warn('Dados de histórico inválidos ou insuficientes');
                    const chartContainer = document.getElementById('skillEvolutionChart');
                    if (chartContainer && chartContainer.parentNode) {
                        chartContainer.parentNode.innerHTML = '<p class="text-center text-gray-500 py-8">Não há dados históricos válidos suficientes para exibir a evolução.</p>';
                    }
                    return;
                }
                
                // Filtrar apenas os dados com performance válida (não 'N/A')
                const validHistoryData = historyData.filter(item => 
                    item && item.performance !== 'N/A' && 
                    item.performance !== undefined && 
                    item.performance !== null
                );
                
                // Se não houver dados suficientes após a filtragem, mostrar mensagem
                if (validHistoryData.length < 2) {
                    const chartContainer = document.getElementById('skillEvolutionChart');
                    if (chartContainer && chartContainer.parentNode) {
                        chartContainer.parentNode.innerHTML = '<p class="text-center text-gray-500 py-8">Não há dados históricos válidos suficientes para exibir a evolução.</p>';
                    }
                    return;
                }
                
                const labels = validHistoryData.map(item => {
                    try {
                        // Extrair apenas o nome da avaliação e o ano para os rótulos do gráfico
                        if (!item.evaluation) return 'N/A';
                        
                        const match = item.evaluation.match(/(.*) - .* \((.*)\)/);
                        if (match) {
                            return `${match[1]} (${match[2]})`;
                        }
                        return item.evaluation;
                    } catch (error) {
                        console.error('Erro ao processar rótulo do gráfico:', error);
                        return 'N/A';
                    }
                });
                
                const performances = validHistoryData.map(item => Number(item.performance) || 0);
                
                // Calcular cores com base no desempenho
                const backgroundColors = performances.map(perf => {
                    if (perf >= 70) return 'rgba(34, 197, 94, 0.6)';
                    if (perf < 60) return 'rgba(239, 68, 68, 0.6)';
                    return 'rgba(234, 179, 8, 0.6)';
                });
                
                const borderColors = performances.map(perf => {
                    if (perf >= 70) return 'rgb(22, 163, 74)';
                    if (perf < 60) return 'rgb(220, 38, 38)';
                    return 'rgb(202, 138, 4)';
                });
                
                // Identificar tendência (melhora, piora ou estável)
                let tendencia = 'Estável';
                let tendenciaClass = 'text-gray-600';
                if (performances.length > 1) {
                    const first = performances[0];
                    const last = performances[performances.length - 1];
                    const diff = last - first;
                    
                    if (diff > 5) {
                        tendencia = 'Melhora significativa';
                        tendenciaClass = 'text-green-600';
                    } else if (diff > 0) {
                        tendencia = 'Leve melhora';
                        tendenciaClass = 'text-green-500';
                    } else if (diff < -5) {
                        tendencia = 'Piora significativa';
                        tendenciaClass = 'text-red-600';
                    } else if (diff < 0) {
                        tendencia = 'Leve piora';
                        tendenciaClass = 'text-red-500';
                    }
                }
                
                // Obter o código da primeira habilidade válida
                const skillCode = validHistoryData[0].code || 'Desconhecido';
                
                // Verificar se o elemento do gráfico existe
                const chartElement = document.getElementById('skillEvolutionChart');
                if (!chartElement) {
                    console.error('Elemento do gráfico não encontrado');
                    return;
                }
                
                // Verificar se já existe um gráfico e destruí-lo
                const existingChart = Chart.getChart(chartElement);
                if (existingChart) {
                    existingChart.destroy();
                }
                
                // Criar o gráfico
                try {
                    const ctx = chartElement.getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Desempenho (%)',
                                data: performances,
                                backgroundColor: backgroundColors,
                                borderColor: 'rgb(59, 130, 246)',
                                borderWidth: 2,
                                pointBackgroundColor: backgroundColors,
                                pointBorderColor: borderColors,
                                pointRadius: 6,
                                pointHoverRadius: 8,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: `Evolução da Habilidade ${skillCode} - ${tendencia}`,
                                    color: tendenciaClass.replace('text-', '').replace('-600', '').replace('-500', '')
                                },
                                tooltip: {
                                    callbacks: {
                                        afterLabel: function(context) {
                                            const index = context.dataIndex;
                                            if (index > 0) {
                                                const diff = performances[index] - performances[index - 1];
                                                const sign = diff > 0 ? '+' : '';
                                                return `Evolução: ${sign}${diff.toFixed(1)}%`;
                                            }
                                            return '';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    min: Math.max(0, Math.min(...performances) - 10),
                                    max: Math.min(100, Math.max(...performances) + 10),
                                    title: {
                                        display: true,
                                        text: 'Desempenho (%)'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Avaliações'
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Erro ao criar gráfico:', error);
                    if (chartElement && chartElement.parentNode) {
                        chartElement.parentNode.innerHTML = '<p class="text-center text-gray-500 py-8">Erro ao renderizar o gráfico: ' + error.message + '</p>';
                    }
                }
            } catch (error) {
                console.error('Erro na função renderSkillEvolutionChart:', error);
                const chartContainer = document.getElementById('skillEvolutionChart');
                if (chartContainer && chartContainer.parentNode) {
                    chartContainer.parentNode.innerHTML = '<p class="text-center text-gray-500 py-8">Erro ao processar dados do gráfico: ' + error.message + '</p>';
                }
            }
        }
        
        // Função para atualizar a paginação
        function updatePagination() {
            const paginationContainer = document.getElementById('paginationContainer');
            paginationContainer.innerHTML = '';
            
            // Calcular número total de páginas com base no total de itens retornado pelo servidor
            const totalPages = Math.ceil(totalBnccItems / itemsPerPage);
            
            // Limitar o número de botões de página
            const maxPageButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);
            
            if (endPage - startPage + 1 < maxPageButtons) {
                startPage = Math.max(1, endPage - maxPageButtons + 1);
            }
            
            // Adicionar botões de página
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.className = `relative inline-flex items-center px-4 py-2 border text-sm font-medium ${
                    i === currentPage 
                        ? 'bg-blue-50 border-blue-500 text-blue-600 z-10' 
                        : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'
                }`;
                pageButton.textContent = i;
                pageButton.addEventListener('click', () => goToPage(i));
                paginationContainer.appendChild(pageButton);
            }
            
            // Atualizar estado dos botões de navegação
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
            document.getElementById('prevPageMobile').disabled = currentPage === 1;
            document.getElementById('nextPageMobile').disabled = currentPage === totalPages;
        }
        
        // Função para mudar de página
        function changePage(delta) {
            // Calcular número total de páginas com base no total de itens retornado pelo servidor
            const totalPages = Math.ceil(totalBnccItems / itemsPerPage);
            const newPage = currentPage + delta;
            
            if (newPage >= 1 && newPage <= totalPages) {
                // Recarregar dados do servidor para a nova página
                // Obter os filtros atuais
                const yearFilter = document.getElementById('filterYear').value;
                const regionFilter = document.getElementById('filterRegion').value;
                const groupFilter = document.getElementById('filterGroup').value;
                const schoolFilter = document.getElementById('filterSchool').value;
                const gradeFilter = document.getElementById('filterGrade').value;
                const classFilter = document.getElementById('filterClass').value;
                const resultsFilter = document.getElementById('filterResults').value;
                
                // Carregar dados da nova página do servidor
                loadBnccSkills(
                    yearFilter, 
                    regionFilter, 
                    groupFilter, 
                    schoolFilter, 
                    gradeFilter, 
                    classFilter, 
                    resultsFilter, 
                    newPage
                );
            }
        }
        
        // Função para ir para uma página específica
        function goToPage(page) {
            // Obter os filtros atuais
            const yearFilter = document.getElementById('filterYear').value;
            const regionFilter = document.getElementById('filterRegion').value;
            const groupFilter = document.getElementById('filterGroup').value;
            const schoolFilter = document.getElementById('filterSchool').value;
            const gradeFilter = document.getElementById('filterGrade').value;
            const classFilter = document.getElementById('filterClass').value;
            const resultsFilter = document.getElementById('filterResults').value;
            
            // Carregar dados da página específica do servidor
            loadBnccSkills(
                yearFilter, 
                regionFilter, 
                groupFilter, 
                schoolFilter, 
                gradeFilter, 
                classFilter, 
                resultsFilter, 
                page
            );
        }
        
        // Função para gerar dados simulados de habilidades BNCC
        function generateBnccSkillsData() {
            // Dados do provas.html modificados para simular dados completos
            const bnccDatabase = {
                "Português": {
                    "1º Ano": [
                        { "code": "EF01LP01", "description": "Reconhecer que textos são lidos e escritos da esquerda para a direita e de cima para baixo da página." },
                        { "code": "EF01LP02", "description": "Escrever, espontaneamente ou por ditado, palavras e frases de forma alfabética – usando letras/grafemas que representem fonemas." },
                        { "code": "EF01LP03", "description": "Observar escritas convencionais, comparando-as às suas produções escritas, percebendo semelhanças e diferenças." }
                    ],
                    "2º Ano": [
                        { "code": "EF02LP01", "description": "Utilizar, ao produzir o texto, grafia correta de palavras conhecidas ou com estruturas silábicas já dominadas, letras maiúsculas em início de frases e em substantivos próprios, segmentação entre as palavras, ponto final, ponto de interrogação e ponto de exclamação." },
                        { "code": "EF02LP02", "description": "Segmentar palavras em sílabas e remover e substituir sílabas iniciais, mediais ou finais para criar novas palavras." },
                        { "code": "EF02LP03", "description": "Ler e escrever palavras com correspondências regulares diretas entre letras e fonemas (f, v, t, d, p, b) e correspondências regulares contextuais (c e q; e e o, em posição átona em final de palavra)." }
                    ]
                },
                "Matemática": {
                    "1º Ano": [
                        { "code": "EF01MA01", "description": "Utilizar números naturais como indicador de quantidade ou de ordem em diferentes situações cotidianas e reconhecer situações em que os números não indicam contagem nem ordem, mas sim código de identificação." },
                        { "code": "EF01MA02", "description": "Contar de maneira exata ou aproximada, utilizando diferentes estratégias como o pareamento e outros agrupamentos." },
                        { "code": "EF01MA03", "description": "Estimar e comparar quantidades de objetos de dois conjuntos (em torno de 20 elementos), por estimativa e/ou por correspondência (um a um, dois a dois) para indicar \"tem mais\", \"tem menos\" ou \"tem a mesma quantidade\"." }
                    ],
                    "2º Ano": [
                        { "code": "EF02MA01", "description": "Comparar e ordenar números naturais (até a ordem de centenas) pela compreensão de características do sistema de numeração decimal (valor posicional e função do zero)." },
                        { "code": "EF02MA02", "description": "Fazer estimativas por meio de estratégias diversas a respeito da quantidade de objetos de coleções e registrar o resultado da contagem desses objetos (até 1000 unidades)." },
                        { "code": "EF02MA03", "description": "Comparar quantidades de objetos de dois conjuntos, por estimativa e/ou por correspondência (um a um, dois a dois, entre outros), para indicar \"tem mais\", \"tem menos\" ou \"tem a mesma quantidade\", indicando, quando for o caso, quantos a mais e quantos a menos." }
                    ]
                }
            };
            
            // Obter escolas para associar às avaliações
            const schools = getSchools();
            const schoolNames = schools.map(s => s.name);
            
            // Obter provas para associar às avaliações
            const exams = getExams();
            const examNames = exams.map(e => e.name);
            
            // Anos para associar às avaliações
            const years = ['2021-2022', '2022-2023', '2023-2024'];
            
            // Expandir os dados para simular desempenho
            const skills = [];
            
            Object.entries(bnccDatabase).forEach(([component, grades]) => {
                Object.entries(grades).forEach(([grade, gradeSkills]) => {
                    gradeSkills.forEach(skill => {
                        // Gerar entre 1 e 3 entradas para cada habilidade com diferentes associações
                        const entriesCount = Math.floor(Math.random() * 3) + 1;
                        
                        for (let i = 0; i < entriesCount; i++) {
                            // Escolher uma escola, uma avaliação e um ano aleatoriamente
                            const randomSchool = schoolNames[Math.floor(Math.random() * schoolNames.length)];
                            const randomExam = examNames[Math.floor(Math.random() * examNames.length)] || 'Avaliação Diagnóstica';
                            const randomYear = years[Math.floor(Math.random() * years.length)];
                            
                            skills.push({
                                code: skill.code,
                                component: component,
                                grade: grade,
                                description: skill.description,
                                evaluation: `${randomExam} - ${randomSchool} (${randomYear})`,
                                performance: Math.floor(Math.random() * 60) + 40 // 40-100%
                            });
                        }
                    });
                });
            });
            
            // Adicionar mais dados de exemplo para paginação
            const moreComponents = ['Ciências', 'História', 'Geografia', 'Arte', 'Educação Física'];
            const moreGrades = ['3º Ano', '4º Ano', '5º Ano'];
            
            for (let i = 0; i < 30; i++) {
                const component = moreComponents[Math.floor(Math.random() * moreComponents.length)];
                const grade = moreGrades[Math.floor(Math.random() * moreGrades.length)];
                const codeNum = String(Math.floor(Math.random() * 20) + 1).padStart(2, '0');
                
                // Escolher uma escola, uma avaliação e um ano aleatoriamente
                const randomSchool = schoolNames[Math.floor(Math.random() * schoolNames.length)];
                const randomExam = examNames[Math.floor(Math.random() * examNames.length)] || 'Avaliação Diagnóstica';
                const randomYear = years[Math.floor(Math.random() * years.length)];
                
                skills.push({
                    code: `EF0${grade.charAt(0)}${component.charAt(0)}${codeNum}`,
                    component: component,
                    grade: grade,
                    description: `Habilidade exemplo de ${component} para ${grade}`,
                    evaluation: `${randomExam} - ${randomSchool} (${randomYear})`,
                    performance: Math.floor(Math.random() * 60) + 40 // 40-100%
                });
            }
            
            return skills;
        }
        
        // Variáveis para controle de paginação do ranking
        let currentRankPage = 1;
        const rankItemsPerPage = 10;
        let totalRankItems = 0; // Total de itens disponíveis no servidor
        
        // Função para carregar o ranking de alunos da API
        async function loadStudentRanking(year = 'all', region = 'all', group = 'all', school = 'all', grade = 'all', classId = 'all', results = 'all', page = 1) {
            // Exibir indicador de carregamento
            document.getElementById('studentRankingList').innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i> Carregando ranking de alunos...</td></tr>';
            
            try {
                // Construir parâmetros da URL para a API com formato consistente
                const params = new URLSearchParams();
                
                // Incluir apenas os parâmetros específicos solicitados
                if (region !== 'all') params.append('regiao_id', region);
                if (group !== 'all') params.append('grupo_id', group);
                if (school !== 'all') params.append('escola_id', school);
                
                // Usar a função comum para adicionar o parâmetro de série
                addGradeParameterToURL(params, grade);
                
                if (classId !== 'all') params.append('turma_id', classId);
                
                // Adicionar parâmetro para resultados apenas se não for "all"
                if (results !== 'all') {
                    params.append('resultados', results === 'high' ? 'melhores' : 'criticos');
                }
                
                // Adicionar parâmetros de paginação
                params.append('page', page);
                params.append('size', rankItemsPerPage);
                
                console.log('Carregando ranking de alunos da API com parâmetros:', params.toString());
                
                const response = await fetch(`https://sag-sag.rak8a3.easypanel.host/api/dashboard/student-ranking?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Ranking de alunos carregado com sucesso:', data);
                    
                    // Verificar formato da resposta paginada
                    if (data && (data.content || data.items || data.data)) {
                        // Extrair conteúdo e informações de paginação
                        const content = data.content || data.items || data.data || [];
                        currentRankPage = data.number !== undefined ? data.number + 1 : (data.page || page);
                        totalRankItems = data.totalElements || data.total || data.count || 0;
                        
                        // Formatar os dados para o formato usado pela UI
                        filteredRanking = content.map((student, index) => {
                            // Função para validar e converter valores numéricos
                            const getValidNumber = (value) => {
                                // Se for null ou undefined, retorna null (que será exibido como N/A)
                                if (value === null || value === undefined) return null;
                                
                                // Se for número, retorna diretamente
                                if (typeof value === 'number' && !isNaN(value)) return value;
                                
                                // Se for string, tenta converter para número
                                if (typeof value === 'string') {
                                    const parsed = parseFloat(value);
                                    if (!isNaN(parsed)) return parsed;
                                }
                                
                                // Caso contrário, retorna null
                                return null;
                            };
                            
                            // Processar os valores numéricos - usar media_geral em vez de media
                            const media = getValidNumber(student.media_geral);
                            const maiorNota = getValidNumber(student.maior_nota);
                            const menorNota = getValidNumber(student.menor_nota);
                            
                            return {
                                id: student.aluno_id,
                                name: student.aluno_nome || student.nome || 'Sem nome',
                                className: student.turma_nome || student.turma || 'N/A',
                                schoolName: student.escola_nome || 'N/A',
                                performance: media, // Pode ser um número ou null
                                totalEvaluations: student.total_desempenhos || 0,
                                highestGrade: maiorNota, // Pode ser um número ou null
                                lowestGrade: menorNota // Pode ser um número ou null
                            };
                        });
                        
                        // Exibir dados e atualizar paginação
                        displayStudentRanking();
                        updateRankPagination();
                    } else if (Array.isArray(data)) {
                        // Compatibilidade com APIs que ainda não implementaram paginação
                        console.warn('API retornou array sem paginação, usando dados para simular paginação');
                        
                        // Formatar os dados para o formato usado pela UI
                        const formattedRanking = data.map((student, index) => {
                            // Função para validar e converter valores numéricos
                            const getValidNumber = (value) => {
                                // Se for null ou undefined, retorna null (que será exibido como N/A)
                                if (value === null || value === undefined) return null;
                                
                                // Se for número, retorna diretamente
                                if (typeof value === 'number' && !isNaN(value)) return value;
                                
                                // Se for string, tenta converter para número
                                if (typeof value === 'string') {
                                    const parsed = parseFloat(value);
                                    if (!isNaN(parsed)) return parsed;
                                }
                                
                                // Caso contrário, retorna null
                                return null;
                            };
                            
                            // Processar os valores numéricos - usar media_geral em vez de media
                            const media = getValidNumber(student.media_geral);
                            const maiorNota = getValidNumber(student.maior_nota);
                            const menorNota = getValidNumber(student.menor_nota);
                            
                            return {
                                id: student.aluno_id,
                                name: student.aluno_nome || student.nome || 'Sem nome',
                                className: student.turma_nome || student.turma || 'N/A',
                                schoolName: student.escola_nome || 'N/A',
                                performance: media, // Pode ser um número ou null
                                totalEvaluations: student.total_desempenhos || 0,
                                highestGrade: maiorNota, // Pode ser um número ou null
                                lowestGrade: menorNota // Pode ser um número ou null
                            };
                        });
                        
                        // Armazenar todos os dados para referência
                        studentRankingData = formattedRanking;
                        totalRankItems = formattedRanking.length;
                        
                        // Aplicar filtros adicionais no cliente (para manter compatibilidade)
                        let localFilteredRanking = [...formattedRanking];
    
                        if (results === 'high') {
                            // Filtrar por melhores resultados (acima de 70%)
                            localFilteredRanking = localFilteredRanking.filter(student => student.performance !== 'N/A' && student.performance >= 70);
                        } else if (results === 'low') {
                            // Filtrar por resultados críticos (abaixo de 60%)
                            localFilteredRanking = localFilteredRanking.filter(student => student.performance !== 'N/A' && student.performance < 60);
                        }
                        
                        // Ordenar por desempenho (do maior para o menor)
                        localFilteredRanking.sort((a, b) => {
                            if (a.performance === 'N/A') return 1;
                            if (b.performance === 'N/A') return -1;
                            return b.performance - a.performance;
                        });
                        
                        // Atualizar total de itens após filtros
                        totalRankItems = localFilteredRanking.length;
                        
                        // Simular paginação no cliente
                        const startIndex = (page - 1) * rankItemsPerPage;
                        const endIndex = Math.min(startIndex + rankItemsPerPage, localFilteredRanking.length);
                        filteredRanking = localFilteredRanking.slice(startIndex, endIndex);
                        
                        // Exibir e atualizar paginação
                        displayStudentRanking();
                        updateRankPagination();
                    } else {
                        console.error('Resposta da API não é um formato paginado ou array:', data);
                        document.getElementById('studentRankingList').innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Erro ao carregar ranking. Formato de resposta inválido.</td></tr>';
                    }
                } else {
                    console.error('Erro ao carregar ranking de alunos da API:', response.status);
                    document.getElementById('studentRankingList').innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Erro ao carregar ranking. Status: ' + response.status + '</td></tr>';
                }
            } catch (error) {
                console.error('Erro ao carregar ranking de alunos:', error);
                document.getElementById('studentRankingList').innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Erro ao carregar ranking: ' + error.message + '</td></tr>';
            }
        }
        
        // Função para exibir o ranking de alunos
        function displayStudentRanking() {
            const tbody = document.getElementById('studentRankingList');
            tbody.innerHTML = '';
            
            // Calcular índices para a página atual com base nos dados paginados do servidor
            const startIndex = (currentRankPage - 1) * rankItemsPerPage + 1;
            const endIndex = startIndex + filteredRanking.length - 1;
            
            // Atualizar informações de paginação
            document.getElementById('rankStartRange').textContent = filteredRanking.length > 0 ? startIndex : 0;
            document.getElementById('rankEndRange').textContent = endIndex;
            document.getElementById('rankTotalItems').textContent = totalRankItems;
            
            // Se não houver resultados
            if (filteredRanking.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                        Nenhum aluno encontrado
                    </td>
                `;
                tbody.appendChild(tr);
                return;
            }
            
            // Adicionar as linhas da tabela
            for (let i = 0; i < filteredRanking.length; i++) {
                const student = filteredRanking[i];
                const position = startIndex + i; // Posição no ranking (baseada no índice da página atual)
                const tr = document.createElement('tr');
                
                // Definir classe de destaque para os três primeiros colocados
                let positionClass = '';
                if (position === 1) {
                    positionClass = 'bg-yellow-100 font-bold';
                } else if (position === 2) {
                    positionClass = 'bg-gray-100 font-bold';
                } else if (position === 3) {
                    positionClass = 'bg-yellow-50 font-bold';
                }
                
                // Definir classe de desempenho e display
                let performanceClass = '';
                let performanceDisplay = '';
                
                if (student.performance === null) {
                    performanceClass = 'text-gray-500';
                    performanceDisplay = 'N/A';
                } else {
                    // Já temos certeza que é um número válido
                    if (student.performance >= 70) {
                        performanceClass = 'text-green-600';
                    } else if (student.performance < 60) {
                        performanceClass = 'text-red-600';
                    } else {
                        performanceClass = 'text-yellow-600';
                    }
                    performanceDisplay = `${student.performance}%`;
                }
                
                // Preparar dados de maior/menor nota
                let highestGradeDisplay = student.highestGrade !== null ? `${student.highestGrade}%` : 'N/A';
                let lowestGradeDisplay = student.lowestGrade !== null ? `${student.lowestGrade}%` : 'N/A';
                
                // Definir cores para maior/menor nota
                let highestGradeClass = '';
                let lowestGradeClass = '';
                
                if (student.highestGrade !== null) {
                    if (student.highestGrade >= 70) {
                        highestGradeClass = 'text-green-600';
                    } else if (student.highestGrade < 60) {
                        highestGradeClass = 'text-red-600';
                    } else {
                        highestGradeClass = 'text-yellow-600';
                    }
                }
                
                if (student.lowestGrade !== null) {
                    if (student.lowestGrade >= 70) {
                        lowestGradeClass = 'text-green-600';
                    } else if (student.lowestGrade < 60) {
                        lowestGradeClass = 'text-red-600';
                    } else {
                        lowestGradeClass = 'text-yellow-600';
                    }
                }
                
                tr.className = positionClass;
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${position}º
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${student.name}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${student.schoolName || 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${student.className || 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${performanceClass}">
                        ${performanceDisplay}
                        ${student.totalEvaluations ? 
                            `<span class="text-xs text-gray-500 ml-1">(${student.totalEvaluations} avaliações)</span>` : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${highestGradeDisplay} / ${lowestGradeDisplay}
                    </td>
                `;
                
                tbody.appendChild(tr);
            }
        }
        
        // Atualizar função de exportação de ranking para usar os novos dados
        function exportRankingToExcel() {
            // Obter os dados filtrados
            const dataToExport = filteredRanking;
            
            if (dataToExport.length === 0) {
                alert('Não há dados para exportar. Por favor, aplique outros filtros.');
                return;
            }
            
            // Obter informações dos filtros atuais
            const yearFilter = document.getElementById('filterYear').value;
            const regionFilter = document.getElementById('filterRegion').value;
            const groupFilter = document.getElementById('filterGroup').value;
            const schoolFilter = document.getElementById('filterSchool').value;
            const gradeFilter = document.getElementById('filterGrade').value;
            const classFilter = document.getElementById('filterClass').value;
            const resultsFilter = document.getElementById('filterResults').value;
            
            // Formatar o nome do filtro de escola
            let schoolName = 'Todas as Escolas';
            if (schoolFilter !== 'all') {
                const schools = getSchools();
                const selectedSchool = schools.find(s => s.id.toString() === schoolFilter.toString());
                if (selectedSchool) {
                    schoolName = selectedSchool.name;
                }
            }
            
            // Formatar o tipo de resultados
            let resultsType = 'Todos os Resultados';
            if (resultsFilter === 'high') {
                resultsType = 'Melhores Resultados';
            } else if (resultsFilter === 'low') {
                resultsType = 'Resultados Críticos';
            }
            
            // Criar um objeto para representar os dados do relatório
            const reportData = {
                title: 'Ranking de Alunos',
                date: new Date().toLocaleDateString('pt-BR'),
                filters: {
                    year: yearFilter === 'all' ? 'Todos os Anos' : yearFilter,
                    region: regionFilter === 'all' ? 'Todas as Regiões' : regionFilter,
                    group: groupFilter === 'all' ? 'Todos os Grupos' : groupFilter,
                    school: schoolName,
                    grade: gradeFilter === 'all' ? 'Todos os Anos' : `${gradeFilter}º Ano`,
                    class: classFilter === 'all' ? 'Todas as Turmas' : classFilter,
                    results: resultsType
                },
                students: dataToExport.map((student, index) => ({
                    posicao: index + 1,
                    nome: student.name,
                    escola: student.schoolName || 'N/A',
                    turma: student.className || 'N/A',
                    desempenho: student.performance === 'N/A' ? 'N/A' : `${student.performance}%`,
                    avaliacoes: student.totalEvaluations || 0,
                    maior_nota: student.highestGrade !== null ? `${student.highestGrade}%` : 'N/A',
                    menor_nota: student.lowestGrade !== null ? `${student.lowestGrade}%` : 'N/A'
                }))
            };
            
            // Mostrar mensagem de progresso
            alert(`Exportando ranking de ${dataToExport.length} alunos para Excel...\n\nRelatório: ${reportData.title}\nData: ${reportData.date}\nFiltros aplicados: ${reportData.filters.year}, ${reportData.filters.region}, ${reportData.filters.group}, ${reportData.filters.school}, ${reportData.filters.grade}, ${reportData.filters.class}, ${reportData.filters.results}`);
            
            // Em uma implementação real, enviaríamos esses dados para o servidor
            // ou usaríamos uma biblioteca como SheetJS para gerar o arquivo no cliente
            
            // Simular o download
            setTimeout(() => {
                const a = document.createElement('a');
                a.href = '#';
                a.download = `ranking_alunos_${new Date().toISOString().slice(0, 10)}.xlsx`;
                a.style.display = 'none';
                document.body.appendChild(a);
                
                // Simular clique no link
                a.click();
                
                // Limpar
                document.body.removeChild(a);
                
                alert('Arquivo Excel exportado com sucesso!');
            }, 1500);
        }
        
        // Função para atualizar a paginação do ranking
        function updateRankPagination() {
            const paginationContainer = document.getElementById('rankPaginationContainer');
            paginationContainer.innerHTML = '';
            
            // Calcular número total de páginas com base no total de itens retornado pelo servidor
            const totalPages = Math.ceil(totalRankItems / rankItemsPerPage);
            
            // Limitar o número de botões de página
            const maxPageButtons = 5;
            let startPage = Math.max(1, currentRankPage - Math.floor(maxPageButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);
            
            if (endPage - startPage + 1 < maxPageButtons) {
                startPage = Math.max(1, endPage - maxPageButtons + 1);
            }
            
            // Adicionar botões de página
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.className = `relative inline-flex items-center px-4 py-2 border text-sm font-medium ${
                    i === currentRankPage 
                        ? 'bg-blue-50 border-blue-500 text-blue-600 z-10' 
                        : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'
                }`;
                pageButton.textContent = i;
                pageButton.addEventListener('click', () => goToRankPage(i));
                paginationContainer.appendChild(pageButton);
            }
            
            // Atualizar estado dos botões de navegação
            document.getElementById('prevRankPage').disabled = currentRankPage === 1;
            document.getElementById('nextRankPage').disabled = currentRankPage === totalPages;
            document.getElementById('prevRankPageMobile').disabled = currentRankPage === 1;
            document.getElementById('nextRankPageMobile').disabled = currentRankPage === totalPages;
        }
        
        // Função para mudar de página no ranking
        function changeRankPage(delta) {
            // Calcular número total de páginas com base no total de itens retornado pelo servidor
            const totalPages = Math.ceil(totalRankItems / rankItemsPerPage);
            const newPage = currentRankPage + delta;
            
            if (newPage >= 1 && newPage <= totalPages) {
                // Recarregar dados do servidor para a nova página
                // Obter os filtros atuais
                const yearFilter = document.getElementById('filterYear').value;
                const regionFilter = document.getElementById('filterRegion').value;
                const groupFilter = document.getElementById('filterGroup').value;
                const schoolFilter = document.getElementById('filterSchool').value;
                const gradeFilter = document.getElementById('filterGrade').value;
                const classFilter = document.getElementById('filterClass').value;
                const resultsFilter = document.getElementById('filterResults').value;
                
                // Carregar dados da nova página do servidor
                loadStudentRanking(
                    yearFilter, 
                    regionFilter, 
                    groupFilter, 
                    schoolFilter, 
                    gradeFilter, 
                    classFilter, 
                    resultsFilter, 
                    newPage
                );
            }
        }
        
        // Função para ir para uma página específica no ranking
        function goToRankPage(page) {
            // Obter os filtros atuais
            const yearFilter = document.getElementById('filterYear').value;
            const regionFilter = document.getElementById('filterRegion').value;
            const groupFilter = document.getElementById('filterGroup').value;
            const schoolFilter = document.getElementById('filterSchool').value;
            const gradeFilter = document.getElementById('filterGrade').value;
            const classFilter = document.getElementById('filterClass').value;
            const resultsFilter = document.getElementById('filterResults').value;
            
            // Carregar dados da página específica do servidor
            loadStudentRanking(
                yearFilter, 
                regionFilter, 
                groupFilter, 
                schoolFilter, 
                gradeFilter, 
                classFilter, 
                resultsFilter, 
                page
            );
        }
        
        // Função para carregar o gráfico de desempenho por avaliação da API
        async function loadExamPerformanceChart(year = 'all', region = 'all', group = 'all', school = 'all', grade = 'all', classId = 'all', results = 'all') {
            try {
                console.log('Carregando desempenho por avaliação...');
                
                // Construir parâmetros da URL para a API com formato consistente
                const params = new URLSearchParams();
                
                // Incluir apenas os parâmetros específicos solicitados
                if (region !== 'all') params.append('regiao_id', region);
                if (group !== 'all') params.append('grupo_id', group);
                if (school !== 'all') params.append('escola_id', school);
                
                // Usar a função comum para adicionar o parâmetro de série
                addGradeParameterToURL(params, grade);
                
                if (classId !== 'all') params.append('turma_id', classId);
                
                // Adicionar parâmetro para resultados apenas se não for "all"
                if (results !== 'all') {
                    params.append('resultados', results === 'high' ? 'melhores' : 'criticos');
                }
                
                console.log('Parâmetros para API de desempenho por avaliação:', params.toString());
                
                // Verificar se o canvas já tem um gráfico e destruí-lo
                const chartCanvas = document.getElementById('examPerformanceChart');
                const chartInstance = Chart.getChart(chartCanvas);
                if (chartInstance) {
                    chartInstance.destroy();
                }
                
                // Exibir indicador de carregamento no gráfico
                const ctx = chartCanvas.getContext('2d');
                ctx.textAlign = 'center';
                ctx.fillStyle = '#888';
                ctx.font = '12px Arial';
                ctx.fillText('Carregando dados...', chartCanvas.width / 2, chartCanvas.height / 2);
                
                // Fazer a requisição para a API
                const response = await fetch(`https://sag-sag.rak8a3.easypanel.host/api/dashboard/provas-desempenho?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Desempenho por provas carregado com sucesso:', data);
                    
                    // Verificar se a resposta é um array
                    if (Array.isArray(data) && data.length > 0) {
                        // Preparar dados para o gráfico
                        const examLabels = data.map(item => item.prova_nome);
                        const examPerformanceData = data.map(item => item.percentual_acertos);
                        
                        // Criar o gráfico com os dados da API
                        new Chart(chartCanvas, {
                            type: 'bar',
                            data: {
                                labels: examLabels,
                                datasets: [{
                                    label: 'Percentual de Acertos (%)',
                                    data: examPerformanceData,
                                    backgroundColor: 'rgba(153, 102, 255, 0.6)',
                                    borderColor: 'rgb(153, 102, 255)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: 'Desempenho por Avaliação'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            afterLabel: function(context) {
                                                const dataIndex = context.dataIndex;
                                                const totalRespostas = data[dataIndex].total_respostas || 'N/A';
                                                const totalAcertos = data[dataIndex].total_acertos || 'N/A';
                                                const percentualErros = data[dataIndex].percentual_erros || 'N/A';
                                                return [
                                                    `Total de respostas: ${totalRespostas}`, 
                                                    `Total de acertos: ${totalAcertos}`,
                                                    `Percentual de erros: ${percentualErros}%`
                                                ];
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100,
                                        title: {
                                            display: true,
                                            text: 'Percentual de Acertos (%)'
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'Avaliações'
                                        }
                                    }
                                }
                            }
                        });
                    } else {
                        displayNoDataChart(chartCanvas, 'Não há dados disponíveis para o gráfico');
                    }
                } else {
                    console.error('Erro ao carregar desempenho por avaliações:', response.status);
                    displayErrorChart(chartCanvas, `Erro ao carregar dados (${response.status})`);
                }
            } catch (error) {
                console.error('Erro ao carregar desempenho por avaliações:', error);
                const chartCanvas = document.getElementById('examPerformanceChart');
                displayErrorChart(chartCanvas, error.message);
            }
        }
        
        // Função para exibir uma mensagem de "Sem dados" em um gráfico
        function displayNoDataChart(canvas, message) {
            try {
                const ctx = canvas.getContext('2d');
                const chartInstance = Chart.getChart(canvas);
                if (chartInstance) {
                    chartInstance.destroy();
                }
                
                // Limpar canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Configuração da mensagem
                ctx.textAlign = 'center';
                ctx.fillStyle = '#888';
                ctx.font = '14px Arial';
                
                // Calcular posição central
                const x = canvas.width / 2;
                const y = canvas.height / 2;
                
                // Desenhar ícone de informação
                ctx.save();
                ctx.font = '24px Arial';
                ctx.fillText('ℹ️', x, y - 15);
                ctx.restore();
                
                // Desenhar mensagem de "Sem dados"
                ctx.fillText(message || 'Nenhum dado disponível', x, y + 15);
                
                console.log(`Exibindo mensagem de "Sem dados" no gráfico: ${message || 'Nenhum dado disponível'}`);
            } catch (error) {
                console.error('Erro ao exibir mensagem de sem dados:', error);
            }
        }

        // Função para carregar o gráfico de componentes curriculares da API
        async function loadCurriculumComponentsChart(year = 'all', region = 'all', group = 'all', school = 'all', grade = 'all', classId = 'all', results = 'all') {
            try {
                console.log('Carregando desempenho por componentes curriculares...');
                
                // Construir parâmetros da URL para a API com formato consistente
                const params = new URLSearchParams();
                
                // Incluir apenas os parâmetros específicos solicitados
                if (region !== 'all') params.append('regiao_id', region);
                if (group !== 'all') params.append('grupo_id', group);
                if (school !== 'all') params.append('escola_id', school);
                
                // Usar a função comum para adicionar o parâmetro de série
                addGradeParameterToURL(params, grade);
                
                if (classId !== 'all') params.append('turma_id', classId);
                
                // Adicionar parâmetro para resultados apenas se não for "all"
                if (results !== 'all') {
                    params.append('resultados', results === 'high' ? 'melhores' : 'criticos');
                }
                
                console.log('Parâmetros para API de componentes curriculares:', params.toString());
                
                // Verificar se o canvas já tem um gráfico e destruí-lo
                const chartCanvas = document.getElementById('curriculumComponentsChart');
                const chartInstance = Chart.getChart(chartCanvas);
                if (chartInstance) {
                    chartInstance.destroy();
                }
                
                // Exibir indicador de carregamento no gráfico
                const ctx = chartCanvas.getContext('2d');
                ctx.textAlign = 'center';
                ctx.fillStyle = '#888';
                ctx.font = '12px Arial';
                ctx.fillText('Carregando dados...', chartCanvas.width / 2, chartCanvas.height / 2);
                
                // Fazer a requisição para a API
                const response = await fetch(`https://sag-sag.rak8a3.easypanel.host/api/dashboard/componentes-curriculares-desempenho?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Desempenho por componentes curriculares carregado com sucesso:', data);
                    
                    // Verificar se a resposta é um array
                    if (Array.isArray(data) && data.length > 0) {
                        // Filtrar apenas componentes com dados válidos e/ou converter null para 0
                        const validData = data.map(item => ({
                            ...item,
                            percentual_acertos: item.percentual_acertos === null ? 0 : 
                                                (isNaN(parseFloat(item.percentual_acertos)) ? 0 : 
                                                 Math.min(parseFloat(item.percentual_acertos), 100)) // Limitar a 100% máximo
                        }));
                        
                        // Preparar dados para o gráfico
                        const componentLabels = validData.map(item => item.componente_nome);
                        const componentPerformanceData = validData.map(item => item.percentual_acertos);
                        
                        // Cores dinâmicas com base no desempenho
                        const backgroundColor = validData.map(item => {
                            const perf = item.percentual_acertos;
                            if (perf >= 70) return 'rgba(34, 197, 94, 0.6)'; // Verde para bom desempenho
                            if (perf < 60 && perf > 0) return 'rgba(239, 68, 68, 0.6)'; // Vermelho para desempenho crítico
                            if (perf === 0) return 'rgba(156, 163, 175, 0.6)'; // Cinza para sem dados
                            return 'rgba(234, 179, 8, 0.6)'; // Amarelo para desempenho médio
                        });
                        
                        const borderColor = validData.map(item => {
                            const perf = item.percentual_acertos;
                            if (perf >= 70) return 'rgb(22, 163, 74)'; // Verde para bom desempenho
                            if (perf < 60 && perf > 0) return 'rgb(220, 38, 38)'; // Vermelho para desempenho crítico
                            if (perf === 0) return 'rgb(107, 114, 128)'; // Cinza para sem dados
                            return 'rgb(202, 138, 4)'; // Amarelo para desempenho médio
                        });
                        
                        // Criar o gráfico com os dados da API
                        new Chart(chartCanvas, {
                            type: 'bar',
                            data: {
                                labels: componentLabels,
                                datasets: [{
                                    label: 'Percentual de Acertos (%)',
                                    data: componentPerformanceData,
                                    backgroundColor: backgroundColor,
                                    borderColor: borderColor,
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: 'Desempenho por Componente Curricular'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            afterLabel: function(context) {
                                                const dataIndex = context.dataIndex;
                                                const totalQuestoes = validData[dataIndex].total_questoes || 0;
                                                const totalRespostas = validData[dataIndex].total_respostas || 0;
                                                const totalAcertos = validData[dataIndex].total_acertos || 0;
                                                
                                                return [
                                                    `Total de questões: ${totalQuestoes}`,
                                                    `Total de respostas: ${totalRespostas}`,
                                                    `Total de acertos: ${totalAcertos}`
                                                ];
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100,
                                        title: {
                                            display: true,
                                            text: 'Percentual de Acertos (%)'
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'Componentes Curriculares'
                                        }
                                    }
                                }
                            }
                        });
                    } else {
                        displayNoDataChart(chartCanvas, 'Não há dados disponíveis para o gráfico');
                    }
                } else {
                    console.error('Erro ao carregar desempenho por componentes curriculares:', response.status);
                    displayErrorChart(chartCanvas, `Erro ao carregar dados (${response.status})`);
                }
            } catch (error) {
                console.error('Erro ao carregar desempenho por componentes curriculares:', error);
                const chartCanvas = document.getElementById('curriculumComponentsChart');
                displayErrorChart(chartCanvas, error.message);
            }
        }

        // Função para calcular a taxa de participação (fallback quando a API não fornece)
        function calculateParticipationRate() {
            try {
                const students = getStudents() || [];
                const exams = getExams() || [];
                
                // Se não tivermos alunos ou provas, a taxa de participação é 0
                if (students.length === 0 || exams.length === 0) {
                    return 0;
                }
                
                // Cálculo simples - podemos melhorar com dados reais de participação quando disponíveis
                // Atualmente, esta é apenas uma estimativa com base no número de alunos e provas
                
                // Em uma implementação real, este cálculo seria baseado em dados de presença real
                // Por enquanto, vamos simplesmente retornar um valor entre 0.7 e 0.95
                return (Math.floor(Math.random() * 25 + 70) / 100);
            } catch (error) {
                console.error('Erro ao calcular taxa de participação:', error);
                return 0;
            }
        }

        // Funções utilitárias para obter dados do localStorage
        function getSchools() {
            try {
                const schoolsData = localStorage.getItem('schools');
                return schoolsData ? JSON.parse(schoolsData) : [];
            } catch (error) {
                console.error('Erro ao obter escolas do localStorage:', error);
                return [];
            }
        }
        
        function getClasses() {
            try {
                const classesData = localStorage.getItem('classes');
                return classesData ? JSON.parse(classesData) : [];
            } catch (error) {
                console.error('Erro ao obter turmas do localStorage:', error);
                return [];
            }
        }
        
        function getStudents() {
            try {
                const studentsData = localStorage.getItem('students');
                return studentsData ? JSON.parse(studentsData) : [];
            } catch (error) {
                console.error('Erro ao obter alunos do localStorage:', error);
                return [];
            }
        }
        
        function getExams() {
            try {
                const examsData = localStorage.getItem('exams');
                return examsData ? JSON.parse(examsData) : [];
            } catch (error) {
                console.error('Erro ao obter provas do localStorage:', error);
                return [];
            }
        }

        // Função para filtrar escolas por região e grupo selecionados
        async function updateSchoolsFilter() {
            try {
                const regionId = document.getElementById('filterRegion').value;
                const groupId = document.getElementById('filterGroup').value;
                const schoolSelector = document.getElementById('filterSchool');
                
                // Mostrar indicador de carregamento no filtro de escolas
                schoolSelector.innerHTML = '<option value="all">Carregando escolas...</option>';
                schoolSelector.disabled = true;
                
                // Construir parâmetros da URL
                const params = new URLSearchParams();
                if (regionId !== 'all') params.append('regiao_id', regionId);
                if (groupId !== 'all') params.append('grupo_id', groupId);
                
                // Se ambos forem "all", carregamos todas as escolas
                if (regionId === 'all' && groupId === 'all') {
                    const schools = await loadSchoolsFromAPI();
                    populateSchoolsFilter(schools);
                    schoolSelector.disabled = false;
                    
                    // Resetar o filtro de turmas também
                    document.getElementById('filterClass').innerHTML = '<option value="all">Todas as turmas</option>';
                    return;
                }
                
                console.log('Carregando escolas filtradas por:', params.toString());
                
                try {
                    const response = await fetch(`https://sag-sag.rak8a3.easypanel.host/api/escolas?${params.toString()}&limit=1000`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Erro ao carregar escolas: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('API escolas filtradas response:', data);
                    
                    // Verificar estrutura da resposta e extrair escolas
                    let schools = [];
                    
                    if (Array.isArray(data)) {
                        schools = data;
                    } else if (data && typeof data === 'object') {
                        // Tentar diferentes propriedades possíveis
                        if (Array.isArray(data.escolas)) schools = data.escolas;
                        else if (Array.isArray(data.items)) schools = data.items;
                        else if (Array.isArray(data.data)) schools = data.data;
                        else if (Array.isArray(data.content)) schools = data.content;
                        // Última tentativa: extrair valores que sejam objetos com id e nome
                        else {
                            schools = Object.values(data).filter(item => 
                                item && typeof item === 'object' && item.id && (item.nome || item.name)
                            );
                        }
                    }
                    
                    // Resetar o select
                    schoolSelector.innerHTML = '<option value="all">Todas as escolas</option>';
                    
                    // Se não houver escolas, mostrar mensagem
                    if (!schools || schools.length === 0) {
                        schoolSelector.innerHTML = '<option value="all">Nenhuma escola encontrada</option>';
                        schoolSelector.disabled = false;
                        
                        // Resetar o filtro de turmas também
                        document.getElementById('filterClass').innerHTML = '<option value="all">Todas as turmas</option>';
                        return;
                    }
                    
                    // Formatar dados das escolas
                    const formattedSchools = schools.map(escola => ({
                        id: escola.id,
                        name: escola.nome || escola.name,
                        region: escola.regiao || escola.region || '',
                        group: escola.grupo || escola.group || ''
                    }));
                    
                    // Ordenar escolas por nome
                    formattedSchools.sort((a, b) => {
                        return a.name.localeCompare(b.name);
                    });
                    
                    // Adicionar as escolas ao select
                    formattedSchools.forEach(school => {
                        const option = document.createElement('option');
                        option.value = school.id;
                        option.textContent = school.name;
                        schoolSelector.appendChild(option);
                    });
                    
                    schoolSelector.disabled = false;
                    console.log(`Filtro de escolas populado com ${formattedSchools.length} escolas relacionadas`);
                    
                    // Resetar o filtro de turmas quando escolas mudam
                    document.getElementById('filterClass').innerHTML = '<option value="all">Todas as turmas</option>';
                    
                } catch (error) {
                    console.error('Erro ao buscar escolas por filtros:', error);
                    schoolSelector.innerHTML = '<option value="all">Erro ao carregar escolas</option>';
                    schoolSelector.disabled = false;
                    
                    // Resetar o filtro de turmas em caso de erro
                    document.getElementById('filterClass').innerHTML = '<option value="all">Todas as turmas</option>';
                }
                
            } catch (error) {
                console.error('Erro ao atualizar filtro de escolas:', error);
                document.getElementById('filterSchool').innerHTML = '<option value="all">Erro ao carregar escolas</option>';
                document.getElementById('filterSchool').disabled = false;
                
                // Resetar o filtro de turmas em caso de erro
                document.getElementById('filterClass').innerHTML = '<option value="all">Todas as turmas</option>';
            }
        }

        // Função para filtrar grupos baseado na região selecionada
        async function updateGroupsFilter() {
            try {
                const regionId = document.getElementById('filterRegion').value;
                const groupSelector = document.getElementById('filterGroup');
                
                // Mostrar indicador de carregamento no filtro de grupos
                groupSelector.innerHTML = '<option value="all">todos os grupos</option>';
                groupSelector.disabled = true;
                
                // Utilizamos a função populateGroupsFilter que já tem toda a lógica necessária
                await populateGroupsFilter(regionId);
                groupSelector.disabled = false;
                
            } catch (error) {
                console.error('Erro ao atualizar filtro de grupos:', error);
                document.getElementById('filterGroup').innerHTML = '<option value="all">Erro ao carregar grupos</option>';
                document.getElementById('filterGroup').disabled = false;
                
                // Mesmo com erro, tentar atualizar escolas
                updateSchoolsFilter();
            }
        }
    </script>
</body>
</html> 